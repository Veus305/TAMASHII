<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAMASHII ‚Äî The Last Soul Chronicle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Noto+Serif+JP:wght@300;400;700&family=Sawarabi+Mincho&display=swap');

:root {
  --sakura: #ffb7c5;
  --sakura-deep: #e8556a;
  --ink: #1a0a0f;
  --ink2: #2d1320;
  --gold: #c9933a;
  --gold-light: #f0c060;
  --spirit: #9b59b6;
  --spirit-light: #d7aef5;
  --teal: #1abc9c;
  --teal-light: #aff0e0;
  --paper: #fdf3e7;
  --panel-bg: rgba(255,183,197,0.04);
  --border: rgba(255,183,197,0.18);
  --shadow-sakura: rgba(255,100,130,0.3);
  --white-spirit: rgba(255,255,255,0.92);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--ink);
  color: var(--paper);
  font-family: 'Noto Serif JP', serif;
  overflow-x: hidden;
  min-height: 100vh;
  cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='4' fill='%23ffb7c5' opacity='0.8'/%3E%3C/svg%3E") 12 12, auto;
}

/* ===== BACKGROUND LAYERS ===== */
.bg-layer {
  position: fixed; top:0; left:0; width:100%; height:100%;
  pointer-events: none; z-index:0;
}
.bg-gradient {
  background:
    radial-gradient(ellipse 70% 50% at 15% 15%, rgba(155,89,182,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 50% 70% at 85% 85%, rgba(232,85,106,0.1) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 50% 50%, rgba(26,188,156,0.04) 0%, transparent 60%),
    linear-gradient(180deg, #0d0508 0%, #1a0a0f 40%, #120810 100%);
}

/* MOON */
.moon {
  position: fixed; top: 60px; right: 80px;
  width: 120px; height: 120px;
  border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, #fffde8, #f0d898 60%, #c9933a);
  box-shadow: 0 0 60px rgba(255,220,100,0.25), 0 0 120px rgba(255,200,80,0.1);
  z-index: 1; pointer-events:none;
  animation: moonGlow 8s ease-in-out infinite;
}
.moon::after {
  content:'';
  position:absolute; top:15px; left:20px;
  width:20px; height:20px; border-radius:50%;
  background: rgba(200,160,60,0.4);
  box-shadow: 30px 10px 0 rgba(200,160,60,0.3), 10px 40px 0 rgba(200,160,60,0.2);
}
@keyframes moonGlow {
  0%,100% { box-shadow: 0 0 60px rgba(255,220,100,0.25); }
  50% { box-shadow: 0 0 80px rgba(255,220,100,0.4), 0 0 160px rgba(255,200,80,0.15); }
}

/* PETALS */
.petal {
  position: fixed;
  font-size: 1rem;
  pointer-events: none;
  z-index: 2;
  animation: petalFall linear infinite;
  opacity: 0;
}
@keyframes petalFall {
  0% { transform: translateY(-30px) rotate(0deg) translateX(0); opacity:0; }
  10% { opacity: 0.7; }
  90% { opacity: 0.3; }
  100% { transform: translateY(105vh) rotate(720deg) translateX(40px); opacity:0; }
}

/* TORII SILHOUETTE */
.torii {
  position: fixed; bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 300px; height: 200px;
  z-index: 1; pointer-events:none; opacity:0.08;
}

/* MAIN */
#app {
  position: relative; z-index: 10;
  max-width: 1100px; margin: 0 auto;
  padding: 20px;
}

/* ===== SCREENS ===== */
.screen { display:none; }
.screen.active { display:block; animation: fadeUp 0.8s cubic-bezier(.16,1,.3,1); }
@keyframes fadeUp {
  from { opacity:0; transform:translateY(30px); }
  to { opacity:1; transform:translateY(0); }
}

/* ===== INTRO ===== */
#intro-screen { text-align: center; padding: 30px 16px; min-height: 100vh; display:none; flex-direction:column; align-items:center; justify-content:center; }
#intro-screen.active { display:flex; }

.kanji-symbol {
  font-size: 6rem;
  color: var(--sakura);
  filter: drop-shadow(0 0 30px rgba(255,183,197,0.5));
  animation: kanjiFloat 4s ease-in-out infinite;
  display: block;
  line-height: 1;
  margin-bottom: 10px;
}
@keyframes kanjiFloat {
  0%,100% { transform: translateY(0); filter: drop-shadow(0 0 20px rgba(255,183,197,0.4)); }
  50% { transform: translateY(-12px); filter: drop-shadow(0 0 40px rgba(255,183,197,0.8)); }
}

.game-title {
  font-family: 'Cinzel Decorative', serif;
  font-size: clamp(2rem, 5vw, 4rem);
  font-weight: 900;
  background: linear-gradient(135deg, var(--sakura) 0%, var(--gold-light) 50%, var(--spirit-light) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 0.05em;
  line-height: 1.1;
}

.game-subtitle {
  font-family: 'Sawarabi Mincho', serif;
  font-size: clamp(0.7rem, 2vw, 1rem);
  letter-spacing: 0.5em;
  color: var(--sakura);
  opacity: 0.6;
  margin: 8px 0 4px;
  text-transform: uppercase;
}

.japanese-sub {
  font-family: 'Sawarabi Mincho', serif;
  font-size: 1.1rem;
  color: var(--sakura);
  opacity: 0.4;
  letter-spacing: 0.3em;
}

/* SCROLL TEXT */
.scroll-container {
  max-width: 680px;
  margin: 30px auto;
  position: relative;
}
.scroll-bg {
  background: linear-gradient(180deg, rgba(253,243,231,0.07) 0%, rgba(253,243,231,0.04) 50%, rgba(253,243,231,0.07) 100%);
  border: 1px solid rgba(201,147,58,0.3);
  border-radius: 4px;
  padding: 36px 32px;
  position: relative;
  overflow: hidden;
}
.scroll-bg::before, .scroll-bg::after {
  content: '';
  position: absolute;
  left:0; right:0; height:24px;
  background: linear-gradient(180deg, rgba(201,147,58,0.15), transparent);
}
.scroll-bg::before { top:0; }
.scroll-bg::after { bottom:0; transform: rotate(180deg); }

.scroll-ornament {
  text-align:center;
  font-size:1.5rem;
  color: var(--gold);
  opacity:0.6;
  margin-bottom:16px;
  letter-spacing:0.5em;
}

.scroll-text {
  font-family: 'Noto Serif JP', serif;
  font-size: 0.92rem;
  line-height: 2;
  color: rgba(253,243,231,0.85);
  text-align: left;
}
.scroll-text .em { color: var(--sakura); font-weight:700; }
.scroll-text .gold { color: var(--gold-light); font-weight:700; }
.scroll-text .spirit { color: var(--spirit-light); font-weight:700; }
.scroll-text .red { color: #ff6b8a; font-weight:700; }

/* ===== BUTTONS ===== */
.btn {
  font-family: 'Cinzel Decorative', serif;
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  padding: 13px 28px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--sakura);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.35s cubic-bezier(.16,1,.3,1);
  border-radius: 2px;
  margin: 6px;
}
.btn::before {
  content:'';
  position:absolute; top:0; left:-100%; width:100%; height:100%;
  background: linear-gradient(90deg, transparent, rgba(255,183,197,0.12), transparent);
  transition: left 0.4s;
}
.btn:hover::before { left:100%; }
.btn:hover {
  border-color: var(--sakura);
  box-shadow: 0 0 20px var(--shadow-sakura);
  transform: translateY(-2px);
}
.btn-gold { border-color: rgba(201,147,58,0.5); color: var(--gold-light); }
.btn-gold:hover { border-color:var(--gold-light); box-shadow:0 0 20px rgba(240,192,96,0.3); }
.btn-spirit { border-color: rgba(155,89,182,0.5); color: var(--spirit-light); }
.btn-spirit:hover { border-color:var(--spirit-light); box-shadow:0 0 20px rgba(155,89,182,0.3); }
.btn-danger { border-color: rgba(255,107,138,0.5); color:#ff6b8a; }
.btn-danger:hover { border-color:#ff6b8a; box-shadow:0 0 20px rgba(255,107,138,0.3); }
.btn-teal { border-color: rgba(26,188,156,0.5); color: var(--teal-light); }
.btn-teal:hover { border-color:var(--teal-light); box-shadow:0 0 20px rgba(26,188,156,0.3); }

/* ===== PANELS ===== */
.panel {
  background: var(--panel-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 22px;
  margin: 14px 0;
  position:relative;
  overflow:hidden;
}
.panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity:0.4;
}
.panel h2 {
  font-family: 'Cinzel Decorative', serif;
  font-size: 0.8rem;
  letter-spacing:0.3em;
  color: var(--gold-light);
  margin-bottom: 18px;
  text-transform:uppercase;
}

/* ===== INPUT ===== */
input[type="text"] {
  width:100%;
  background: rgba(253,243,231,0.05);
  border: 1px solid rgba(201,147,58,0.3);
  border-radius: 2px;
  padding: 14px 18px;
  color: var(--gold-light);
  font-family: 'Sawarabi Mincho', serif;
  font-size: 1.1rem;
  letter-spacing:0.1em;
  outline:none;
  transition: all 0.3s;
  margin-bottom:16px;
}
input[type="text"]:focus {
  border-color: var(--gold);
  box-shadow: 0 0 15px rgba(201,147,58,0.2);
}
input[type="text"]::placeholder { color:rgba(201,147,58,0.3); }

/* ===== CLASS CARDS ===== */
.class-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(155px,1fr));
  gap: 12px;
}
.class-card {
  border: 1px solid rgba(201,147,58,0.2);
  border-radius: 4px;
  padding: 18px 14px;
  cursor:pointer;
  text-align:center;
  transition: all 0.3s cubic-bezier(.16,1,.3,1);
  background: rgba(253,243,231,0.03);
  position:relative;
  overflow:hidden;
}
.class-card:hover, .class-card.selected {
  border-color: var(--sakura);
  background: rgba(255,183,197,0.07);
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(255,100,130,0.15);
}
.class-card.selected::after {
  content:'‚ú¶ CHOSEN';
  position:absolute; top:6px; right:6px;
  font-family:'Cinzel Decorative',serif; font-size:0.5rem;
  color:var(--gold-light); letter-spacing:0.1em;
}
.class-icon { font-size:2.8rem; display:block; margin-bottom:10px; }
.class-name { font-family:'Cinzel Decorative',serif; font-size:0.65rem; color:var(--sakura); letter-spacing:0.2em; margin-bottom:6px; }
.class-jp { font-family:'Sawarabi Mincho',serif; font-size:1rem; color:var(--gold); opacity:0.5; margin-bottom:6px; }
.class-desc { font-size:0.72rem; color:rgba(253,243,231,0.55); line-height:1.5; }
.class-ability { font-size:0.65rem; color:var(--spirit-light); margin-top:6px; font-style:italic; }

/* ===== MODE CARDS ===== */
.mode-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:14px; }
.mode-card {
  border: 1px solid rgba(201,147,58,0.2);
  border-radius: 4px;
  padding: 22px 18px;
  cursor:pointer;
  transition: all 0.3s cubic-bezier(.16,1,.3,1);
  background: rgba(253,243,231,0.02);
  text-align:center;
}
.mode-card:hover { transform:translateY(-5px); }
.mode-card.bond:hover { border-color:var(--sakura); box-shadow:0 10px 30px rgba(255,100,130,0.2); }
.mode-card.relic:hover { border-color:var(--gold-light); box-shadow:0 10px 30px rgba(240,192,96,0.2); }
.mode-card.spirit:hover { border-color:var(--spirit-light); box-shadow:0 10px 30px rgba(155,89,182,0.2); }
.mode-icon { font-size:3rem; display:block; margin-bottom:12px; }
.mode-title { font-family:'Cinzel Decorative',serif; font-size:0.8rem; letter-spacing:0.2em; margin-bottom:8px; }
.bond .mode-title { color:var(--sakura); }
.relic .mode-title { color:var(--gold-light); }
.spirit-m .mode-title { color:var(--spirit-light); }
.mode-desc { font-size:0.78rem; color:rgba(253,243,231,0.5); line-height:1.6; }

/* ===== GAME HEADER ===== */
.game-header {
  background: rgba(26,10,15,0.9);
  border: 1px solid rgba(201,147,58,0.25);
  border-radius: 4px;
  padding: 14px 20px;
  display:flex; justify-content:space-between; align-items:center;
  flex-wrap:wrap; gap:10px;
  margin-bottom:14px;
  position:relative;
  overflow:hidden;
}
.game-header::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--sakura), transparent);
  opacity:0.3;
}

.player-info { display:flex; align-items:center; gap:14px; }
.player-avatar {
  width:52px; height:52px; border-radius:50%;
  border:2px solid var(--gold);
  display:flex; align-items:center; justify-content:center;
  font-size:1.6rem;
  background: radial-gradient(circle, rgba(201,147,58,0.15), rgba(26,10,15,0.9));
  box-shadow: 0 0 20px rgba(201,147,58,0.25);
  animation: avatarBreath 4s ease-in-out infinite;
}
@keyframes avatarBreath {
  0%,100% { box-shadow:0 0 15px rgba(201,147,58,0.2); }
  50% { box-shadow:0 0 35px rgba(201,147,58,0.5), 0 0 60px rgba(255,183,197,0.1); }
}

.stat-row { display:flex; gap:18px; flex-wrap:wrap; }
.stat { text-align:center; }
.stat-label { font-family:'Cinzel Decorative',serif; font-size:0.5rem; letter-spacing:0.2em; color:rgba(201,147,58,0.5); text-transform:uppercase; }
.stat-value { font-family:'Cinzel Decorative',serif; font-size:1rem; color:var(--gold-light); }
.hp-group { display:flex; flex-direction:column; gap:4px; }
.hp-bar { width:110px; height:6px; background:rgba(255,255,255,0.08); border-radius:3px; overflow:hidden; }
.hp-fill { height:100%; background: linear-gradient(90deg,#ff6b8a, var(--sakura)); border-radius:3px; transition: width 0.6s cubic-bezier(.16,1,.3,1); }

/* ===== GAME BOARD ===== */
.game-board {
  display:grid;
  grid-template-columns: 1fr 310px;
  gap:14px;
}
@media(max-width:680px) { .game-board { grid-template-columns:1fr; } }

/* ===== MAP ===== */
.map-container {
  background: rgba(13,5,8,0.95);
  border:1px solid rgba(201,147,58,0.2);
  border-radius:4px;
  padding:18px;
  min-height:380px;
  position:relative;
  overflow:hidden;
}
.map-container::before {
  content:'';
  position:absolute; inset:0;
  background-image:
    linear-gradient(rgba(201,147,58,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(201,147,58,0.03) 1px, transparent 1px);
  background-size:30px 30px;
}
.map-title { font-family:'Cinzel Decorative',serif; font-size:0.6rem; letter-spacing:0.35em; color:rgba(201,147,58,0.4); margin-bottom:14px; text-transform:uppercase; }

/* ===== DICE ===== */
.dice-wrap { text-align:center; margin:14px 0; }
.dice {
  width:88px; height:88px;
  background: linear-gradient(135deg, rgba(201,147,58,0.15), rgba(155,89,182,0.15));
  border: 2px solid rgba(201,147,58,0.5);
  border-radius: 12px;
  display:inline-flex; align-items:center; justify-content:center;
  font-family:'Cinzel Decorative',serif;
  font-size:2.2rem; font-weight:900;
  color: var(--gold-light);
  cursor:pointer;
  transition: all 0.3s;
  box-shadow: 0 0 20px rgba(201,147,58,0.15), inset 0 0 20px rgba(201,147,58,0.05);
  position:relative;
}
.dice:hover { transform:scale(1.1) rotate(6deg); box-shadow:0 0 40px rgba(201,147,58,0.4); }
.dice.rolling { animation:diceRoll 0.7s cubic-bezier(.36,.07,.19,.97); }
@keyframes diceRoll {
  0%{transform:scale(1) rotate(0deg);}
  20%{transform:scale(1.4) rotate(-200deg);}
  50%{transform:scale(0.8) rotate(400deg);}
  80%{transform:scale(1.2) rotate(650deg);}
  100%{transform:scale(1) rotate(720deg);}
}
.dice-label { font-family:'Sawarabi Mincho',serif; font-size:0.65rem; color:rgba(201,147,58,0.4); letter-spacing:0.3em; margin-top:8px; }

/* ===== HINT BOX ===== */
.hint-box {
  background: linear-gradient(135deg, rgba(155,89,182,0.08), rgba(26,188,156,0.05));
  border: 1px solid rgba(155,89,182,0.3);
  border-radius:4px;
  padding:12px 16px;
  font-size:0.8rem;
  color:rgba(215,174,245,0.85);
  line-height:1.7;
  margin-bottom:12px;
  position:relative;
}
.hint-box::before {
  content:'üí° HINT';
  font-family:'Cinzel Decorative',serif;
  font-size:0.55rem;
  letter-spacing:0.25em;
  color:var(--spirit-light);
  display:block;
  margin-bottom:6px;
}
.hint-toggle {
  font-family:'Cinzel Decorative',serif; font-size:0.55rem;
  letter-spacing:0.2em; color:var(--spirit-light);
  background:none; border:1px solid rgba(155,89,182,0.3);
  border-radius:2px; padding:5px 12px;
  cursor:pointer; transition:all 0.2s; width:100%; margin-top:8px;
}
.hint-toggle:hover { border-color:var(--spirit-light); background:rgba(155,89,182,0.1); }

/* ===== LOG ===== */
.event-log {
  background: rgba(0,0,0,0.6);
  border: 1px solid rgba(201,147,58,0.12);
  border-radius:4px;
  padding:14px;
  height:180px;
  overflow-y:auto;
  font-size:0.8rem;
  line-height:1.75;
}
.event-log::-webkit-scrollbar { width:3px; }
.event-log::-webkit-scrollbar-thumb { background:rgba(201,147,58,0.3); border-radius:2px; }
.log-entry { margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.04); }
.log-entry.good { color:var(--teal-light); }
.log-entry.bad { color:#ff9aaa; }
.log-entry.neutral { color:rgba(253,243,231,0.5); }
.log-entry.special { color:var(--gold-light); }
.log-entry.spirit-log { color:var(--spirit-light); }

/* ===== SIDE PANEL ===== */
.side-panel { display:flex; flex-direction:column; gap:12px; }
.side-box {
  background: rgba(13,5,8,0.9);
  border:1px solid rgba(201,147,58,0.15);
  border-radius:4px;
  padding:16px;
  position:relative;
  overflow:hidden;
}
.side-box::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg,transparent,rgba(201,147,58,0.4),transparent);
}
.side-box h3 {
  font-family:'Cinzel Decorative',serif;
  font-size:0.6rem;
  letter-spacing:0.3em;
  color:rgba(201,147,58,0.6);
  text-transform:uppercase;
  margin-bottom:12px;
}

/* OBJECTIVES */
.obj-item {
  display:flex; align-items:flex-start; gap:8px;
  margin-bottom:8px; font-size:0.78rem;
  color:rgba(253,243,231,0.55);
  line-height:1.5;
}
.obj-item.done { color:rgba(26,188,156,0.7); text-decoration:line-through; opacity:0.7; }
.obj-dot { min-width:14px; color:var(--sakura); font-size:0.9rem; }

/* INVENTORY */
.inv-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:8px; }
.inv-slot {
  aspect-ratio:1;
  background:rgba(0,0,0,0.4);
  border:1px solid rgba(201,147,58,0.12);
  border-radius:3px;
  display:flex; align-items:center; justify-content:center;
  font-size:1.2rem; cursor:default; transition:all 0.2s;
  position:relative;
}
.inv-slot:hover { border-color:rgba(201,147,58,0.4); }
.inv-slot[title]:hover::after {
  content:attr(title);
  position:absolute; bottom:110%; left:50%; transform:translateX(-50%);
  background:rgba(13,5,8,0.95); border:1px solid rgba(201,147,58,0.3);
  padding:4px 8px; font-size:0.6rem;
  font-family:'Cinzel Decorative',serif;
  white-space:nowrap; color:var(--gold-light);
  border-radius:2px; z-index:100;
}

/* PROGRESS */
.prog-bar { height:5px; background:rgba(255,255,255,0.08); border-radius:3px; overflow:hidden; margin-top:6px; }
.prog-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--spirit),var(--sakura)); transition:width 0.6s; }
.prog-labels { display:flex; justify-content:space-between; font-family:'Cinzel Decorative',serif; font-size:0.55rem; color:rgba(201,147,58,0.4); margin-top:3px; }

/* FIELD STATS */
.field-stat { display:flex; justify-content:space-between; align-items:center; margin-bottom:7px; }
.field-label { font-family:'Cinzel Decorative',serif; font-size:0.55rem; letter-spacing:0.15em; color:rgba(201,147,58,0.4); }
.field-value { font-family:'Cinzel Decorative',serif; font-size:0.9rem; }

/* KARMA GAUGE */
.karma-container { margin-top:8px; }
.karma-bar-wrap { height:8px; background:rgba(255,255,255,0.06); border-radius:4px; overflow:hidden; position:relative; }
.karma-fill-light { position:absolute; top:0; left:50%; height:100%; background:linear-gradient(90deg,var(--gold),var(--teal)); border-radius:0 4px 4px 0; transition:width 0.6s; }
.karma-fill-dark { position:absolute; top:0; right:50%; height:100%; background:linear-gradient(90deg,#ff6b8a,#9b1030); border-radius:4px 0 0 4px; transition:width 0.6s; transform-origin:right; }
.karma-labels { display:flex; justify-content:space-between; font-size:0.55rem; color:rgba(255,255,255,0.3); margin-top:3px; font-family:'Cinzel Decorative',serif; }

/* ===== MODAL ===== */
.modal-overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.88);
  z-index:1000;
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(6px);
  animation:fadeUp 0.3s ease;
}
.modal {
  background: linear-gradient(135deg, #0d0508, #160a10);
  border:1px solid rgba(201,147,58,0.35);
  border-radius:6px;
  padding:32px;
  max-width:520px; width:92%;
  position:relative;
  box-shadow: 0 0 80px rgba(255,100,130,0.15), 0 0 40px rgba(201,147,58,0.1);
  overflow:hidden;
}
.modal::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background: linear-gradient(90deg, transparent, var(--gold), var(--sakura), transparent);
  opacity:0.7;
}
.modal::after {
  content:'‚ú¶ ‚ú¶ ‚ú¶';
  position:absolute; bottom:14px; right:16px;
  font-size:0.6rem; color:rgba(201,147,58,0.3);
  letter-spacing:0.4em;
}
.modal-type-badge {
  font-family:'Cinzel Decorative',serif;
  font-size:0.55rem; letter-spacing:0.4em;
  margin-bottom:10px; opacity:0.7;
  text-transform:uppercase;
}
.modal-title {
  font-family:'Cinzel Decorative',serif;
  font-size:1.1rem; letter-spacing:0.1em;
  margin-bottom:6px;
}
.modal-jp { font-family:'Sawarabi Mincho',serif; font-size:1rem; opacity:0.3; margin-bottom:16px; }
.encounter-art {
  font-size:4.5rem; text-align:center; display:block;
  margin:10px 0;
  animation:artFloat 2.5s ease-in-out infinite;
}
@keyframes artFloat { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-10px) scale(1.05);} }
.modal-desc {
  font-size:0.87rem; color:rgba(253,243,231,0.75);
  line-height:1.85; margin-bottom:18px;
}
.modal-hint {
  background:rgba(155,89,182,0.08); border:1px solid rgba(155,89,182,0.2);
  border-radius:3px; padding:10px 14px;
  font-size:0.75rem; color:var(--spirit-light);
  margin-bottom:16px; line-height:1.6;
}
.modal-hint::before { content:'‚ü° Hint: '; font-weight:700; }
.modal-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

/* ===== WIN SCREEN ===== */
#win-screen, #gameover-screen { text-align:center; padding:40px 16px; }
.win-badge {
  font-size:5rem; display:block;
  animation:winPulse 2s ease-in-out infinite;
}
@keyframes winPulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }
.win-title {
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(1.5rem,4vw,3rem);
  color:var(--gold-light);
  filter:drop-shadow(0 0 20px rgba(240,192,96,0.5));
  margin:16px 0 8px;
}
.score-big {
  font-family:'Cinzel Decorative',serif;
  font-size:3.5rem;
  color:var(--sakura);
  filter:drop-shadow(0 0 20px rgba(255,183,197,0.5));
}
.epilogue-box {
  max-width:640px; margin:24px auto;
  background:rgba(253,243,231,0.04); border:1px solid rgba(201,147,58,0.25);
  border-radius:4px; padding:28px 24px;
  text-align:left;
  font-size:0.88rem; line-height:1.9;
  color:rgba(253,243,231,0.75);
}
.epilogue-box h3 {
  font-family:'Cinzel Decorative',serif;
  font-size:0.8rem; letter-spacing:0.3em;
  color:var(--gold-light); margin-bottom:16px;
}

/* ===== PETALS CONFETTI ===== */
.petal-burst { position:fixed; inset:0; pointer-events:none; z-index:999; }
.burst-petal {
  position:absolute;
  animation:burstFall linear forwards;
}
@keyframes burstFall {
  0%{transform:translateY(-20px) rotate(0deg);opacity:1;}
  100%{transform:translateY(105vh) rotate(540deg);opacity:0;}
}

/* CHERRY BLOSSOM tree */
.sakura-tree {
  position:fixed; bottom:0; left:20px;
  width:180px; height:300px;
  z-index:1; pointer-events:none; opacity:0.12;
}

/* ===== TWIST BANNER ===== */
.fate-banner {
  background:linear-gradient(90deg,rgba(155,89,182,0.15),rgba(255,107,138,0.1));
  border:1px solid rgba(155,89,182,0.4);
  border-radius:3px; padding:12px 16px;
  font-family:'Cinzel Decorative',serif;
  font-size:0.7rem; letter-spacing:0.15em;
  color:var(--spirit-light); text-align:center;
  margin:10px 0;
  animation:fatePulse 1.5s ease-in-out 3;
}
@keyframes fatePulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

/* SCROLL BAR */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--ink);}
::-webkit-scrollbar-thumb{background:rgba(201,147,58,0.25);border-radius:3px;}
</style>
</head>
<body>

<!-- BACKGROUND LAYERS -->
<div class="bg-layer bg-gradient"></div>
<div class="moon"></div>

<!-- SAKURA TREE SVG -->
<svg class="sakura-tree" viewBox="0 0 180 300" xmlns="http://www.w3.org/2000/svg">
  <line x1="90" y1="300" x2="90" y2="140" stroke="#8B4513" stroke-width="12" stroke-linecap="round"/>
  <line x1="90" y1="200" x2="50" y2="150" stroke="#8B4513" stroke-width="7" stroke-linecap="round"/>
  <line x1="90" y1="180" x2="130" y2="140" stroke="#8B4513" stroke-width="7" stroke-linecap="round"/>
  <line x1="90" y1="160" x2="60" y2="120" stroke="#8B4513" stroke-width="5" stroke-linecap="round"/>
  <circle cx="90" cy="110" r="55" fill="#ffb7c5" opacity="0.6"/>
  <circle cx="50" cy="130" r="35" fill="#e8556a" opacity="0.5"/>
  <circle cx="130" cy="125" r="38" fill="#ffb7c5" opacity="0.55"/>
  <circle cx="70" cy="90" r="30" fill="#e8a0b0" opacity="0.5"/>
  <circle cx="110" cy="95" r="28" fill="#ffb7c5" opacity="0.45"/>
</svg>

<div id="app">

<!-- ============================================================ -->
<!-- INTRO SCREEN -->
<!-- ============================================================ -->
<div id="intro-screen" class="screen active">
  <span class="kanji-symbol">È≠Ç</span>
  <div class="game-title">TAMASHII</div>
  <div class="game-subtitle">The Last Soul Chronicle</div>
  <div class="japanese-sub">È≠Ç„ÅÆÊúÄÂæå„ÅÆÂπ¥‰ª£Ë®ò</div>

  <div class="scroll-container">
    <div class="scroll-bg">
      <div class="scroll-ornament">‚Äî ‚ú¶ ‚Äî</div>
      <div class="scroll-text">
        <p>In the age when the spirit realm and the mortal world still breathed as one, there existed a village named <span class="em">Hanenoi</span> ‚Äî meaning "the place where feathers never fall." Its people lived in laughter, in prayer, in the humble warmth of paper lanterns that floated each autumn into the sky.</p>
        <br>
        <p>They believed those lanterns carried their prayers to the <span class="gold">Spirit Goddess, Y≈´rei-no-Hana</span> ‚Äî <em>the Flower of the Dead</em>. She was said to tend the great <span class="em">Soul Tree</span> at the center of existence, a divine sakura whose petals kept the boundary between life and death in perfect balance.</p>
        <br>
        <p>Then came <span class="red">the Night of Fallen Petals.</span></p>
        <br>
        <p>Without warning, the Soul Tree began to wither. Its petals ‚Äî each one a human soul tethered to the living world ‚Äî rained down like snow into the abyss. People fell into deep, unbreakable sleep. Children stopped laughing. Elders stopped breathing. The lanterns no longer lit.</p>
        <br>
        <p>The Spirit Goddess herself has been <span class="red">imprisoned</span> inside a corrupted Oni called <span class="spirit">Mugen-Oni</span> ‚Äî the Endless Demon ‚Äî who seeks to devour every soul that remains so that he alone becomes immortal. Without her, the Soul Tree cannot bloom again. Without the tree, <span class="red">all souls ‚Äî living and dead ‚Äî will fade into eternal nothingness.</span></p>
        <br>
        <p>You are the last <span class="gold">Tamashii-Keeper</span> ‚Äî the one soul the Goddess marked before she was taken. Your ancestors whispered your name into the wind. The dice of fate have been cast. <span class="em">Roll them true, and perhaps she can still be saved.</span></p>
        <br>
        <p style="text-align:center;opacity:0.5;font-style:italic;">You have until the last petal falls.</p>
      </div>
      <div class="scroll-ornament" style="margin-top:16px;">‚Äî ‚ú¶ ‚Äî</div>
    </div>
  </div>

  <button class="btn btn-gold" onclick="showScreen('character-screen')" style="font-size:0.9rem;padding:16px 50px;margin-top:8px;">
    ‚ú¶ BEGIN YOUR CHRONICLE ‚ú¶
  </button>
  <div style="margin-top:12px;font-family:'Sawarabi Mincho',serif;font-size:0.8rem;color:rgba(201,147,58,0.35);letter-spacing:0.2em;">
    Âßã„ÇÅ„Åæ„Åó„Çá„ÅÜ ‚Äî Let us begin
  </div>
</div>

<!-- ============================================================ -->
<!-- CHARACTER SCREEN -->
<!-- ============================================================ -->
<div id="character-screen" class="screen">
  <div style="text-align:center;padding:20px 0 10px;">
    <div style="font-family:'Cinzel Decorative',serif;font-size:0.7rem;letter-spacing:0.4em;color:rgba(201,147,58,0.5);">CHARACTER CREATION</div>
    <div style="font-family:'Sawarabi Mincho',serif;font-size:1.4rem;color:var(--sakura);margin-top:4px;opacity:0.5;">„Ç≠„É£„É©„ÇØ„Çø„Éº‰ΩúÊàê</div>
  </div>

  <div class="panel">
    <h2>‚ú¶ Your Name in the Spirit Realm</h2>
    <input type="text" id="player-name-input" placeholder="Enter your spirit name..." maxlength="20"/>
    <div style="font-size:0.75rem;color:rgba(201,147,58,0.4);font-style:italic;margin-top:-10px;margin-bottom:4px;">
      This name will be woven into the Soul Tree's bark forever.
    </div>
  </div>

  <div class="panel">
    <h2>‚ú¶ Choose Your Spirit Path</h2>
    <div class="class-grid">
      <div class="class-card" onclick="selectClass('kenshi')" id="class-kenshi">
        <span class="class-icon">‚öîÔ∏è</span>
        <div class="class-name">Kenshi</div>
        <div class="class-jp">Ââ£Â£´</div>
        <div class="class-desc">The Way of the Sword. Fierce and direct. High combat power, strong against Oni.</div>
        <div class="class-ability">‚òÖ Can deal critical strikes (roll 5-6 = double damage)</div>
      </div>
      <div class="class-card" onclick="selectClass('miko')" id="class-miko">
        <span class="class-icon">‚õ©Ô∏è</span>
        <div class="class-name">Miko</div>
        <div class="class-jp">Â∑´Â•≥</div>
        <div class="class-desc">Shrine Maiden. Speaks with spirits. Can purify cursed tiles and heal wounds.</div>
        <div class="class-ability">‚òÖ Purify (skip curse/trap) once per 5 turns</div>
      </div>
      <div class="class-card" onclick="selectClass('kitsune')" id="class-kitsune">
        <span class="class-icon">ü¶ä</span>
        <div class="class-name">Kitsune</div>
        <div class="class-jp">Áãê</div>
        <div class="class-desc">Nine-tailed trickster spirit. Can re-roll twice. Unpredictable, cunning, alive.</div>
        <div class="class-ability">‚òÖ Re-roll the dice (2√ó per game)</div>
      </div>
      <div class="class-card" onclick="selectClass('ryuujin')" id="class-ryuujin">
        <span class="class-icon">üêâ</span>
        <div class="class-name">Ryuujin</div>
        <div class="class-jp">ÈæçÁ•û</div>
        <div class="class-desc">Dragon descendant. Immense vitality. Slow but nearly unstoppable force of nature.</div>
        <div class="class-ability">‚òÖ Dragon Scales: half damage from all traps</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>‚ú¶ Choose Your Sacred Quest</h2>
    <div class="mode-grid">
      <div class="mode-card bond" onclick="selectMode('bond')">
        <span class="mode-icon">üå∏</span>
        <div class="mode-title">Bond of Souls</div>
        <div class="mode-desc">Three spirit fragments of the Goddess are scattered. Reunite them before the 20th turn to free her. Emotional. Heartbreaking. Worth it.</div>
      </div>
      <div class="mode-card relic" onclick="selectMode('relic')">
        <span class="mode-icon">‚ö±Ô∏è</span>
        <div class="mode-title">Relic Hunt</div>
        <div class="mode-desc">Gather 5 sacred relics hidden inside chests across the spirit realm. Each holds a memory of the Goddess. Greed may corrupt you.</div>
      </div>
      <div class="mode-card spirit-m" onclick="selectMode('spirit')">
        <span class="mode-icon">üïØÔ∏è</span>
        <div class="mode-title">Spirit Vigil</div>
        <div class="mode-desc">Hold the light for 25 turns. As long as you breathe, the Soul Tree lives. Every turn you survive, another soul is saved from the void.</div>
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-top:8px;">
    <button class="btn btn-gold" onclick="startGame()">‚ú¶ ENTER THE SPIRIT REALM ‚ú¶</button>
  </div>
</div>

<!-- ============================================================ -->
<!-- GAME SCREEN -->
<!-- ============================================================ -->
<div id="game-screen" class="screen">

  <div class="game-header">
    <div class="player-info">
      <div class="player-avatar" id="player-avatar">?</div>
      <div>
        <div style="font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--gold-light);" id="display-name">‚Äî</div>
        <div style="font-family:'Sawarabi Mincho',serif;font-size:0.8rem;color:rgba(255,183,197,0.5);" id="display-class">‚Äî</div>
      </div>
    </div>
    <div class="stat-row">
      <div class="stat"><div class="stat-label">Soul Pts</div><div class="stat-value" id="score-disp">0</div></div>
      <div class="stat"><div class="stat-label">Turn</div><div class="stat-value" id="turn-disp">1/20</div></div>
      <div class="stat"><div class="stat-label">Karma</div><div class="stat-value" id="karma-disp" style="font-size:0.85rem;">Neutral</div></div>
    </div>
    <div class="hp-group">
      <div class="stat-label">Life Force <span id="hp-num" style="color:var(--sakura);">100</span></div>
      <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
    </div>
  </div>

  <div class="game-board">
    <!-- LEFT -->
    <div>
      <div class="map-container">
        <div class="map-title">‚ú¶ THE SPIRIT REALM ‚Äî CURSED TERRITORY ‚ú¶</div>
        <svg id="map-svg" viewBox="0 0 460 320" style="width:100%;height:310px;"></svg>
      </div>

      <div class="panel" style="margin-top:14px;">
        <div class="hint-box" id="hint-display">
          Roll the dice to traverse the spirit realm. Each node holds a different fate ‚Äî some sacred, some cursed. Read the hints before you choose your action.
        </div>
        <button class="hint-toggle" onclick="cycleHint()">‚ü° Next Hint ‚ü°</button>

        <div class="dice-wrap" style="margin-top:14px;">
          <div class="dice" id="dice" onclick="rollDice()">üé≤</div>
          <div class="dice-label">‚Äî Tap the dice ‚Äî Fate is cast by your hand ‚Äî</div>
          <div id="reroll-zone" style="margin-top:8px;text-align:center;"></div>
        </div>

        <div style="font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.35em;color:rgba(201,147,58,0.4);text-transform:uppercase;margin:10px 0 6px;">Chronicles</div>
        <div class="event-log" id="event-log">
          <div class="log-entry neutral">[ The spirit realm stirs... Your journey begins at the Sacred Gate. ]</div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="side-panel">

      <!-- OBJECTIVES -->
      <div class="side-box">
        <h3>Sacred Objectives</h3>
        <div id="objectives-list"></div>
        <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
        <div class="prog-labels"><span>FATE</span><span id="prog-pct">0%</span></div>
      </div>

      <!-- KARMA -->
      <div class="side-box">
        <h3>Karma Balance</h3>
        <div class="karma-container">
          <div class="karma-bar-wrap">
            <div class="karma-fill-light" id="karma-light" style="width:0%"></div>
            <div class="karma-fill-dark" id="karma-dark" style="width:0%"></div>
          </div>
          <div class="karma-labels"><span>‚òØ LIGHT</span><span>DARK ‚õ©</span></div>
        </div>
        <div style="font-size:0.72rem;color:rgba(253,243,231,0.4);margin-top:8px;line-height:1.6;" id="karma-desc">
          Your choices between mercy and force shape your karma, and your karma shapes the Soul Tree's fate.
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="side-box">
        <h3>Sacred Relics</h3>
        <div class="inv-grid" id="inventory-grid"></div>
      </div>

      <!-- STATS -->
      <div class="side-box">
        <h3>Field Records</h3>
        <div class="field-stat"><span class="field-label">ONI VANQUISHED</span><span class="field-value" id="stat-kills" style="color:#ff9aaa;">0</span></div>
        <div class="field-stat"><span class="field-label">SHRINES BLESSED</span><span class="field-value" id="stat-shrines" style="color:var(--teal-light);">0</span></div>
        <div class="field-stat"><span class="field-label">PORTALS CROSSED</span><span class="field-value" id="stat-portals" style="color:var(--spirit-light);">0</span></div>
        <div class="field-stat"><span class="field-label">SOULS SAVED</span><span class="field-value" id="stat-souls" style="color:var(--gold-light);">0</span></div>
        <div class="field-stat"><span class="field-label">RE-ROLLS LEFT</span><span class="field-value" id="stat-rerolls" style="color:var(--sakura);">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- WIN SCREEN -->
<!-- ============================================================ -->
<div id="win-screen" class="screen">
  <div class="petal-burst" id="petal-burst"></div>
  <br>
  <span class="win-badge" id="win-badge">üå∏</span>
  <div class="win-title" id="win-title">THE GODDESS IS FREE</div>
  <div style="font-family:'Sawarabi Mincho',serif;font-size:1.2rem;color:rgba(255,183,197,0.4);margin:4px 0 20px;">È≠Ç„ÅØËß£Êîæ„Åï„Çå„Åü</div>

  <div class="score-big" id="final-score">0</div>
  <div style="font-family:'Cinzel Decorative',serif;font-size:0.65rem;letter-spacing:0.3em;color:rgba(201,147,58,0.6);margin:4px 0 24px;">SOUL POINTS EARNED</div>

  <div class="epilogue-box" id="win-epilogue">
    <h3>‚ú¶ EPILOGUE ‚Äî WHAT HAPPENED</h3>
  </div>

  <div id="win-stats-block" style="max-width:500px;margin:20px auto;display:flex;justify-content:center;gap:30px;flex-wrap:wrap;"></div>
  <button class="btn btn-gold" onclick="restart()" style="margin-top:20px;">‚ú¶ Play Another Chronicle ‚ú¶</button>
</div>

<!-- ============================================================ -->
<!-- GAME OVER SCREEN -->
<!-- ============================================================ -->
<div id="gameover-screen" class="screen">
  <br><br>
  <span style="font-size:5rem;display:block;text-align:center;">üåë</span>
  <div style="font-family:'Cinzel Decorative',serif;font-size:2.5rem;color:#ff6b8a;text-align:center;filter:drop-shadow(0 0 30px rgba(255,107,138,0.5));margin:16px 0;">
    THE PETALS HAVE FALLEN
  </div>
  <div style="font-family:'Sawarabi Mincho',serif;font-size:1.1rem;color:rgba(255,107,138,0.4);text-align:center;margin-bottom:24px;">
    Ëä±„Å≥„Çâ„ÅØÊï£„Çä„Åæ„Åó„Åü
  </div>

  <div class="epilogue-box" id="gameover-epilogue" style="max-width:640px;margin:0 auto 24px;">
    <h3 style="color:#ff9aaa;">‚ú¶ WHAT WILL HAPPEN ‚Äî IF NO ONE COMES</h3>
  </div>

  <div style="text-align:center;">
    <div class="score-big" id="gameover-score" style="color:#ff9aaa;">0</div>
    <div style="font-family:'Cinzel Decorative',serif;font-size:0.65rem;color:rgba(255,107,138,0.5);letter-spacing:0.3em;margin:4px 0 24px;">FINAL SOUL COUNT</div>
    <button class="btn btn-danger" onclick="restart()">‚ú¶ Try Again ‚ú¶</button>
  </div>
</div>

</div><!-- #app -->

<!-- ============================================================ -->
<!-- ENCOUNTER MODAL -->
<!-- ============================================================ -->
<div id="modal-overlay" class="modal-overlay" style="display:none;">
  <div class="modal">
    <div class="modal-type-badge" id="modal-badge">‚Äî EVENT ‚Äî</div>
    <div class="modal-title" id="modal-title">ENCOUNTER</div>
    <div class="modal-jp" id="modal-jp">Âá∫‰ºö„ÅÑ</div>
    <span class="encounter-art" id="modal-art">?</span>
    <div class="modal-desc" id="modal-desc"></div>
    <div class="modal-hint" id="modal-hint-text"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<!-- PETALS -->
<div id="petal-layer"></div>

<script>
// ============================
// TAMASHII ‚Äî GAME ENGINE
// ============================

const CLASSES = {
  kenshi:   { icon:'‚öîÔ∏è', jpName:'Ââ£Â£´', hp:95,  rerolls:0, purify:0 },
  miko:     { icon:'‚õ©Ô∏è', jpName:'Â∑´Â•≥', hp:100, rerolls:0, purify:3 },
  kitsune:  { icon:'ü¶ä', jpName:'Áãê',   hp:85,  rerolls:2, purify:0 },
  ryuujin:  { icon:'üêâ', jpName:'ÈæçÁ•û', hp:130, rerolls:0, purify:0 },
};

const MODES = {
  bond:   { label:'BOND OF SOULS',  color:'var(--sakura)',      turns:20, total:3, jp:'È≠Ç„ÅÆÁµÜ' },
  relic:  { label:'RELIC HUNT',     color:'var(--gold-light)',  turns:28, total:5, jp:'ÈÅ∫Áâ©Áã©„Çä' },
  spirit: { label:'SPIRIT VIGIL',   color:'var(--spirit-light)',turns:25, total:0, jp:'Á≤æÁ•û„ÅÆÂÆàË≠∑' },
};

let state = {};
let selClass = '', selMode = '';
let hintIndex = 0;

const HINTS = [
  'üå∏ Shrine tiles restore HP. Seek them when your life force is low.',
  '‚öîÔ∏è Fighting Oni with high karma (Light) grants bonus soul points.',
  'ü¶ä Kitsune re-rolls are best saved for curse or Oni tiles.',
  '‚õ©Ô∏è Miko can purify a cursed tile ‚Äî use it to avoid deadly traps.',
  'üíé Some relics heal; others increase your combat dice roll.',
  'üêâ Ryuujin takes only half damage from all trap tiles.',
  'üåÄ Spirit Portals can jump you 2‚Äì6 nodes forward ‚Äî or backward!',
  '‚òØÔ∏è Choices of mercy build Light karma. Karma affects your endings.',
  'üìú Read every scroll. They contain fragments of the Goddess\'s story.',
  'üåë Dark karma players receive darker versions of the epilogue.',
  '‚ö±Ô∏è Collecting 5 relics in Relic Hunt mode shows a secret cutscene.',
  'üïØÔ∏è In Spirit Vigil, every 5 turns you survive purifies one lost soul.',
  'üí° The exit tile only works when all objectives are complete.',
  'üé≤ Rolling a 6 on a combat tile is always a critical ‚Äî bonus 50pts!',
  'üå∏ The Soul Tree blooms more with each soul you save. Watch the log.',
];

const NODE_TYPES = ['normal','normal','chest','oni','shrine','portal','curse','scroll','relic','normal'];

const MAP_NODES = [];
function buildMap() {
  MAP_NODES.length = 0;
  for(let i=0;i<25;i++) {
    const col = i%5, row = Math.floor(i/5);
    const x = 46 + col*88 + (row%2)*44;
    const y = 38 + row*58;
    let type = i===0?'start':i===24?'exit':NODE_TYPES[Math.floor(Math.random()*NODE_TYPES.length)];
    MAP_NODES.push({id:i, x, y, type, visited:false, cleared:false});
  }
}

// RENDER SVG MAP
function renderMap() {
  const svg = document.getElementById('map-svg');
  svg.innerHTML = '';

  // grid lines
  MAP_NODES.forEach((n,i) => {
    if(i%5<4) drawEdge(svg, n, MAP_NODES[i+1]);
    if(i<20)  drawEdge(svg, n, MAP_NODES[i+5]);
  });

  MAP_NODES.forEach((n,i) => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('transform',`translate(${n.x},${n.y})`);

    const nodeColors = {
      start:'#c9933a', exit:'#c9933a', chest:'#f0c060', oni:'#ff6b8a',
      shrine:'#1abc9c', portal:'#9b59b6', curse:'#8b0030', scroll:'#7fa8c8',
      relic:'#d4a0ff', normal:'#2d1320'
    };
    const nodeIcons = {
      start:'‚õ©', exit:'üå∏', chest:'üì¶', oni:'üë∫', shrine:'‚õ©',
      portal:'üåÄ', curse:'üíÄ', scroll:'üìú', relic:'‚ö±Ô∏è', normal:''
    };

    // Hexagon
    const r = 19;
    const pts = Array.from({length:6},(_,k)=>{
      const a=Math.PI/180*(60*k-30);
      return `${r*Math.cos(a)},${r*Math.sin(a)}`;
    }).join(' ');
    const hex = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    hex.setAttribute('points',pts);
    hex.setAttribute('fill', state.position===i ? 'rgba(201,147,58,0.2)' : n.visited ? 'rgba(13,5,8,0.7)' : 'rgba(13,5,8,0.9)');
    hex.setAttribute('stroke', state.position===i ? '#c9933a' : (n.cleared ? 'rgba(201,147,58,0.15)' : (nodeColors[n.type]||'#2d1320')));
    hex.setAttribute('stroke-width', state.position===i ? '2.5' : '1.5');
    hex.setAttribute('opacity', n.visited&&!state.position===i ? '0.5' : '1');
    g.appendChild(hex);

    // Player pos ring
    if(state.position===i) {
      const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
      ring.setAttribute('r','13'); ring.setAttribute('fill','none');
      ring.setAttribute('stroke','rgba(255,183,197,0.5)'); ring.setAttribute('stroke-width','2');
      ring.innerHTML = '<animate attributeName="r" values="12;16;12" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/>';
      g.appendChild(ring);
    }

    // Icon text
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','central');
    t.setAttribute('font-size','12');
    t.textContent = state.position===i
      ? (CLASSES[state.playerClass]?.icon||'?')
      : (n.cleared ? '¬∑' : (nodeIcons[n.type]||''));
    g.appendChild(t);

    svg.appendChild(g);
  });
}

function drawEdge(svg,a,b) {
  const l = document.createElementNS('http://www.w3.org/2000/svg','line');
  l.setAttribute('x1',a.x); l.setAttribute('y1',a.y);
  l.setAttribute('x2',b.x); l.setAttribute('y2',b.y);
  l.setAttribute('stroke','rgba(201,147,58,0.07)'); l.setAttribute('stroke-width','1');
  svg.appendChild(l);
}

// ============================
// UI HELPERS
// ============================

function selectClass(cls) {
  selClass = cls;
  document.querySelectorAll('.class-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('class-'+cls)?.classList.add('selected');
  playSound('select');
}
function selectMode(mode) {
  selMode = mode;
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('selected'));
  playSound('select');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function addLog(msg, type='neutral') {
  const log = document.getElementById('event-log');
  const d = document.createElement('div');
  d.className='log-entry '+type;
  d.innerHTML = msg;
  log.prepend(d);
  while(log.children.length>60) log.removeChild(log.lastChild);
}

function cycleHint() {
  hintIndex = (hintIndex+1)%HINTS.length;
  document.getElementById('hint-display').innerHTML = HINTS[hintIndex];
  playSound('hint');
}

function updateStats() {
  document.getElementById('score-disp').textContent = state.score;
  document.getElementById('turn-disp').textContent = `${state.turn}/${state.turnLimit}`;
  document.getElementById('hp-num').textContent = Math.max(0,state.hp);
  document.getElementById('hp-fill').style.width = Math.max(0,(state.hp/state.maxHp)*100)+'%';
  document.getElementById('stat-kills').textContent = state.kills;
  document.getElementById('stat-shrines').textContent = state.shrines;
  document.getElementById('stat-portals').textContent = state.portals;
  document.getElementById('stat-souls').textContent = state.soulsSaved;
  document.getElementById('stat-rerolls').textContent = state.rerolls;

  // Karma
  const k = state.karma; // -100 to +100
  const lightPct = Math.max(0, k/100*50);
  const darkPct  = Math.max(0, -k/100*50);
  document.getElementById('karma-light').style.width = lightPct+'%';
  document.getElementById('karma-dark').style.width  = darkPct+'%';
  const kLabel = k>40?'Pure Light':k>10?'Light':k>-10?'Neutral':k>-40?'Shadow':'Dark Soul';
  document.getElementById('karma-disp').textContent = kLabel;
  document.getElementById('karma-desc').textContent =
    k>30 ? 'Your light karma opens mercy paths and empowers shrine healing.' :
    k<-30 ? 'Dark karma makes Oni fear you, but spirits keep their distance.' :
    'Your karma is balanced. Both paths remain open to you.';

  // Progress
  let prog=0;
  if(state.gameMode==='bond') prog=(state.soulFragments/3)*100;
  else if(state.gameMode==='relic') prog=(state.relicsFound/5)*100;
  else prog=(state.turn/state.turnLimit)*100;
  prog=Math.min(100,prog);
  document.getElementById('prog-fill').style.width=prog+'%';
  document.getElementById('prog-pct').textContent=Math.round(prog)+'%';
}

function renderObjectives() {
  const el=document.getElementById('objectives-list');
  el.innerHTML='';
  state.objectives.forEach(o=>{
    const d=document.createElement('div');
    d.className='obj-item'+(o.done?' done':'');
    d.innerHTML=`<span class="obj-dot">${o.done?'‚ú¶':'‚óã'}</span>${o.label}`;
    el.appendChild(d);
  });
}

function renderInventory() {
  const g=document.getElementById('inventory-grid');
  g.innerHTML='';
  for(let i=0;i<8;i++) {
    const slot=document.createElement('div');
    slot.className='inv-slot';
    if(state.inventory[i]){
      slot.textContent=state.inventory[i].icon;
      slot.title=state.inventory[i].name.toUpperCase();
    }
    g.appendChild(slot);
  }
}

function renderRerolls() {
  const z=document.getElementById('reroll-zone');
  z.innerHTML='';
  if(state.rerolls>0){
    const b=document.createElement('button');
    b.className='hint-toggle';
    b.style.borderColor='rgba(155,89,182,0.4)'; b.style.color='var(--spirit-light)';
    b.textContent=`‚ü° Re-Roll the Dice (${state.rerolls} left) ‚ü°`;
    b.onclick=()=>{ if(!state.rolling&&!state.pending&&state.rerolls>0){state.rerolls--;rollDice();} };
    z.appendChild(b);
  }
  if(state.playerClass==='miko'&&state.purify>0){
    const b2=document.createElement('button');
    b2.className='hint-toggle';
    b2.style.marginTop='6px'; b2.style.borderColor='rgba(26,188,156,0.4)'; b2.style.color='var(--teal-light)';
    b2.textContent=`‚ü° Purify Next Tile (${state.purify} left) ‚ü°`;
    b2.onclick=()=>{ if(state.purify>0){state.purifyNext=true; state.purify--; addLog('‚õ©Ô∏è Purification ready. Next curse/trap will be cleansed.','good'); renderRerolls();} };
    z.appendChild(b2);
  }
}

// ============================
// START GAME
// ============================
function startGame() {
  const name=document.getElementById('player-name-input').value.trim();
  if(!name){document.getElementById('player-name-input').style.borderColor='#ff6b8a';return;}
  if(!selClass){alert('Choose your spirit path, wanderer.');return;}
  if(!selMode){alert('Choose your sacred quest.');return;}

  const cls=CLASSES[selClass], mode=MODES[selMode];
  state={
    playerName:name, playerClass:selClass, gameMode:selMode,
    hp:cls.hp, maxHp:cls.hp, score:0, turn:1,
    position:0, kills:0, shrines:0, portals:0, soulsSaved:0,
    rerolls:cls.rerolls, purify:cls.purify, purifyNext:false,
    karma:0, inventory:[], objectives:[],
    turnLimit:mode.turns, gameOver:false, rolling:false, pending:false,
    soulFragments:0, relicsFound:0,
    objectivesTotal:mode.total,
  };
  buildObjectives();
  buildMap();
  MAP_NODES[0].visited=true;

  document.getElementById('display-name').textContent=name;
  document.getElementById('display-class').textContent=cls.jpName+' ‚Äî '+selClass.toUpperCase();
  document.getElementById('player-avatar').textContent=cls.icon;

  showScreen('game-screen');
  updateStats(); renderMap(); renderObjectives(); renderInventory(); renderRerolls();
  playSound('startup');
}

function buildObjectives() {
  if(state.gameMode==='bond'){
    state.objectives=[
      {label:'Find the Fragment of Memory (Âåó)',done:false},
      {label:'Find the Fragment of Love (Âçó)',done:false},
      {label:'Return to the Soul Gate (È≠Ç)',done:false},
    ];
  } else if(state.gameMode==='relic'){
    state.objectives=Array.from({length:5},(_,i)=>({label:`Sacred Relic ${i+1}`,done:false}));
  } else {
    state.objectives=[{label:'Survive 25 turns for the Soul Tree',done:false}];
  }
}

// ============================
// DICE + MOVEMENT
// ============================
function rollDice() {
  if(state.rolling||state.gameOver||state.pending) return;
  state.rolling=true;
  const dice=document.getElementById('dice');
  dice.classList.add('rolling');
  playSound('roll');

  let ticks=0;
  const id=setInterval(()=>{
    dice.textContent=Math.ceil(Math.random()*6);
    ticks++;
    if(ticks>=14){
      clearInterval(id);
      const roll=Math.ceil(Math.random()*6);
      dice.textContent=roll;
      dice.classList.remove('rolling');
      state.rolling=false;
      addLog(`üé≤ The dice speaks: <strong>${roll}</strong> ‚Äî moving ${roll} nodes...`,'neutral');
      setTimeout(()=>doMove(roll),400);
    }
  },70);
}

function doMove(roll) {
  let steps = roll;
  // Ryuujin slow ‚Äî but extra HP regen
  if(state.playerClass==='ryuujin' && roll<3) {
    const heal=5; state.hp=Math.min(state.maxHp,state.hp+heal);
    addLog('üêâ Dragon vitality surges. +5 HP from slow movement.','good');
  }
  const newPos=Math.min(state.position+steps,24);
  state.position=newPos;
  MAP_NODES[newPos].visited=true;
  state.turn++;
  state.score+=8;
  updateStats(); renderMap();

  if(state.turn>state.turnLimit&&state.gameMode!=='spirit'){
    setTimeout(()=>showEncounter('THE LAST PETAL FALLS','Oni','üåë',
      'Time has run out. The Soul Tree\'s final petal drops into the void. The Goddess\'s light flickers and dies.',
      'When time expires, even the bravest soul cannot hold back fate.',
      [{label:'Accept the End',cls:'btn-danger',act:'gameover'}]),600);
    return;
  }
  setTimeout(()=>triggerNode(newPos),600);
}

// ============================
// NODE EVENTS
// ============================
const ONI_ENCOUNTERS=[
  {name:'Kage-Oni',jp:'ÂΩ±È¨º',art:'üë∫',desc:'A shadow demon that feeds on memories. It tears at your mind with cold, invisible claws. You feel yourself forgetting ‚Äî your mother\'s face, your village\'s scent. Fight before it steals more.',hint:'Rolling 4+ defeats it. Kenshi gets +1 to their roll.'},
  {name:'Mugen\'s Shade',jp:'ÁÑ°Èôê„ÅÆÂΩ±',art:'ü©∏',desc:'A fragment of the Endless Demon itself. Its eyes are the color of grief. You can feel it probing your fear. It whispers: "She is already gone. Lay down your dice. Rest forever."',hint:'Don\'t believe what it says. Fight or flee ‚Äî both have consequences.'},
  {name:'Bone Lantern',jp:'È™®ÊèêÁÅØ',art:'üèÆ',desc:'What was once a beautiful spirit lantern has been corrupted. It floats toward you, grinning. Inside its flame is a trapped human soul ‚Äî screaming silently. Defeat it to free the soul.',hint:'Defeating this Oni saves a soul and increases your score significantly.'},
];

const CHEST_EVENTS=[
  {name:'Memory Chest',jp:'Ë®òÊÜ∂„ÅÆÁÆ±',art:'üì¶',desc:'A wooden chest wrapped in faded ribbon. Inside is warm to the touch ‚Äî as if it remembers the hands that once held it. The Goddess left these for her faithful.',hint:'Force open for speed; examine carefully to avoid traps.'},
  {name:'The Goddess\'s Gift',jp:'Â•≥Á•û„ÅÆË¥à„ÇäÁâ©',art:'üéÅ',desc:'A box that smells of cherry blossoms and rain. You feel an ache in your chest ‚Äî not pain, but longing. Something inside loves you, though you\'ve never met.',hint:'These chests are always safe. They are her way of saying thank you.'},
];

const SCROLL_EVENTS=[
  {name:'Ancient Scroll',jp:'Âè§‰ª£„ÅÆÂ∑ªÁâ©',art:'üìú',desc:'"When the Keeper rolls true and the cherry blooms again, I will open my eyes. Do not mourn me ‚Äî I am in every petal that falls. I will always find you." ‚Äî Y≈´rei-no-Hana',hint:'Scrolls restore 10 HP and grant 40 soul points. Always read them.'},
  {name:'The Goddess\'s Letter',jp:'Â•≥Á•û„ÅÆÊâãÁ¥ô',art:'üìñ',desc:'"Mugen was my student once. I taught him to tend the souls of the dead ‚Äî to be gentle with them. He grew jealous of their love for me. When love becomes possession, it becomes a cage. Free me... and forgive him."',hint:'Every scroll piece you find reveals more of her story. Find all 5 for the true ending.'},
];

const SHRINE_EVENTS=[
  {name:'Forgotten Shrine',jp:'Âøò„Çå„Çâ„Çå„ÅüÁ•ûÁ§æ',art:'‚õ©Ô∏è',desc:'Moss-covered stone. An old offering bowl filled with long-dried flowers. Someone prayed here for a very long time. You add your prayer. Something warm answers.',hint:'Shrines heal 20-30 HP. Always stop to pray ‚Äî even if you don\'t believe.'},
  {name:'Weeping Shrine',jp:'Ê≥£„ÅèÁ•ûÁ§æ',art:'üïØÔ∏è',desc:'You find a shrine where a child\'s toy rests against the stone. A child who never came home from the Night of Fallen Petals. You light the candle that\'s been waiting years.',hint:'Praying here adds +1 to your next combat roll and grants Light karma.'},
];

const RELIC_EVENTS=[
  {name:'The Bell of Parting',jp:'Âà•„Çå„ÅÆÈêò',art:'üîî',desc:'A small bronze bell. When you ring it, it produces a sound so achingly beautiful that you stop breathing for a moment. The note hangs in the air like a goodbye that never finished.',hint:'This is a sacred relic. Collect it for your mission ‚Äî and your heart.'},
  {name:'The Mirror of Souls',jp:'È≠Ç„ÅÆÈè°',art:'ü™û',desc:'You look into it expecting your reflection. Instead you see the Goddess ‚Äî thin, transparent, imprisoned in chains of shadow. She mouths two words: "Hurry. Please."',hint:'This relic grants a significant score bonus and reveals a story fragment.'},
];

function triggerNode(pos) {
  const node=MAP_NODES[pos];
  const t=node.type;
  state.pending=true;

  if(t==='start'){ state.pending=false; return; }
  if(t==='exit'){
    if(checkWinCondition()){triggerWin(); return;}
    addLog('üå∏ You find the Soul Gate, but your mission is not yet complete.','neutral');
    state.pending=false; return;
  }

  if(state.purifyNext && (t==='curse'||t==='oni')){
    state.purifyNext=false;
    addLog('‚õ©Ô∏è Purification activated! The Miko\'s prayer cleanses the corruption.','good');
    state.score+=50; state.karma+=15;
    node.cleared=true; state.pending=false;
    updateStats(); renderMap(); return;
  }

  switch(t) {
    case 'oni':     showOniEvent(); break;
    case 'chest':   showChestEvent(); break;
    case 'shrine':  showShrineEvent(); break;
    case 'portal':  showPortalEvent(); break;
    case 'curse':   showCurseEvent(); break;
    case 'scroll':  showScrollEvent(); break;
    case 'relic':   showRelicEvent(); break;
    default:        showNormalEvent(); break;
  }
}

function showOniEvent() {
  const e=ONI_ENCOUNTERS[Math.floor(Math.random()*ONI_ENCOUNTERS.length)];
  const actions=[
    {label:'‚öîÔ∏è Fight with Honor', cls:'btn-danger', act:'fight-honor'},
    {label:'üèÉ Flee into Shadow', cls:'btn',         act:'flee'},
  ];
  if(state.playerClass==='miko') actions.push({label:'‚õ©Ô∏è Pray for Mercy',cls:'btn-teal',act:'fight-prayer'});
  playSound('oni');
  showEncounter(e.name, e.jp, e.art, e.desc, e.hint, actions);
}

function showChestEvent() {
  const e=CHEST_EVENTS[Math.floor(Math.random()*CHEST_EVENTS.length)];
  const actions=[
    {label:'üì¶ Open with Hope', cls:'btn-gold', act:'chest-open'},
    {label:'üîç Examine Carefully', cls:'btn',   act:'chest-safe'},
  ];
  playSound('chest');
  showEncounter(e.name, e.jp, e.art, e.desc, e.hint, actions);
}

function showShrineEvent() {
  const e=SHRINE_EVENTS[Math.floor(Math.random()*SHRINE_EVENTS.length)];
  showEncounter(e.name, e.jp, e.art, e.desc, e.hint, [
    {label:'üôè Pray and Offer', cls:'btn-teal', act:'shrine'},
    {label:'‚Üí Pass by', cls:'btn', act:'close', pts:0},
  ]);
  playSound('shrine');
}

function showPortalEvent() {
  showEncounter('Spirit Portal','Á≤æÁ•û„Éù„Éº„Çø„É´','üåÄ',
    'A swirling gate of violet light opens before you. The wind that flows from it carries the scent of a world that no longer exists ‚Äî ancient forests, temple bells, incense and starlight. The Goddess once walked through a door just like this.',
    'Portals move you 2‚Äì6 nodes forward or backward. In the spirit realm, not all roads go where you expect.',
    [{label:'üåÄ Step Through',cls:'btn-spirit',act:'portal'},{label:'‚Üê Turn Back',cls:'btn',act:'close',pts:5}]);
}

function showCurseEvent() {
  showEncounter('Cursed Hex','Âë™„Çè„Çå„ÅüÂë™Êñá','üíÄ',
    'A dark symbol burns into the ground beneath your feet. The air turns cold. You feel fingers wrapping around your heart ‚Äî not to stop it, but to slow it. This tile was laid by Mugen-Oni himself.',
    'Cursed tiles deal 15-25 damage. Miko can purify these. Ryuujin takes only 10.',
    [{label:'‚ö° Push Through',cls:'btn-danger',act:'curse'},{label:'‚öîÔ∏è Resist Actively',cls:'btn',act:'curse-resist'}]);
  playSound('curse');
}

function showScrollEvent() {
  const e=SCROLL_EVENTS[Math.floor(Math.random()*SCROLL_EVENTS.length)];
  showEncounter(e.name, e.jp, e.art, e.desc, e.hint,
    [{label:'üìú Read with Care', cls:'btn-gold', act:'scroll'}]);
  playSound('scroll');
}

function showRelicEvent() {
  const e=RELIC_EVENTS[Math.floor(Math.random()*RELIC_EVENTS.length)];
  showEncounter(e.name, e.jp, e.art, e.desc, e.hint,
    [{label:'‚ö±Ô∏è Collect the Relic', cls:'btn-gold', act:'relic'}]);
  playSound('chest');
}

function showNormalEvent() {
  const normals=[
    {t:'Drifting Soul',jp:'ÊºÇ„ÅÜÈ≠Ç',art:'üëª',d:'A transparent figure drifts past you ‚Äî a soul untethered since the Night of Fallen Petals. It reaches toward you but cannot touch. Its eyes hold a question it has forgotten how to ask.',h:'Lost souls sometimes leave items behind. Search the area.'},
    {t:'Cherry Blossom Storm',jp:'Ê°úÂêπÈõ™',art:'üå∏',d:'A sudden gust of wind fills the air with sakura petals. For a moment ‚Äî just a moment ‚Äî you feel the Soul Tree breathing. As if it knows you are coming. As if it is holding on for you.',h:'This is a rest tile. Safe to pass through. Restore your resolve.'},
    {t:'Moonlit Path',jp:'ÊúàÊòé„Åã„Çä„ÅÆÈÅì',art:'üåï',d:'The path ahead glows silver under an impossibly large moon. Somewhere far away, a temple bell rings ‚Äî three times, then silence. You take a breath. You keep going.',h:'No danger here. Take a moment. You are doing better than you think.'},
  ];
  const e=normals[Math.floor(Math.random()*normals.length)];
  showEncounter(e.t, e.jp, e.art, e.d, e.h, [{label:'Continue Forward',cls:'btn',act:'close',pts:15}]);
}

// ============================
// ENCOUNTER MODAL
// ============================
function showEncounter(title, jp, art, desc, hint, actions) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-jp').textContent = jp;
  document.getElementById('modal-art').textContent = art;
  document.getElementById('modal-desc').innerHTML = desc;
  document.getElementById('modal-hint-text').textContent = hint;
  const acts = document.getElementById('modal-actions');
  acts.innerHTML='';
  actions.forEach(a=>{
    const b=document.createElement('button');
    b.className='btn '+(a.cls||'');
    b.textContent=a.label;
    b.onclick=()=>resolveAction(a);
    acts.appendChild(b);
  });
  document.getElementById('modal-overlay').style.display='flex';
}

function closeModal(){ document.getElementById('modal-overlay').style.display='none'; state.pending=false; }

function resolveAction(a) {
  closeModal();
  MAP_NODES[state.position].cleared=true;

  switch(a.act) {
    case 'close':
      if(a.pts){ state.score+=a.pts; addLog(`You press onward. +${a.pts} soul points.`,'neutral'); }
      else addLog('You move on through the spirit realm.','neutral');
      break;

    case 'fight-honor': {
      const roll=Math.ceil(Math.random()*6);
      const bonus=state.playerClass==='kenshi'?1:0;
      const critical=state.playerClass==='kenshi'&&(roll+bonus>=5);
      if(roll+bonus>=3) {
        const pts=critical?150:80+roll*15;
        state.kills++; state.score+=pts; state.karma+=10; state.soulsSaved++;
        addLog(`‚öîÔ∏è Victory! Roll: ${roll}${bonus?'+1':''}.${critical?' CRITICAL STRIKE!':''} +${pts} pts. A soul freed!`,'good');
        checkBondProgress();
        playSound('win');
      } else {
        const dmg=Math.floor(Math.random()*20)+15;
        state.hp-=dmg; state.karma-=5;
        addLog(`üíî Defeated by the Oni. -${dmg} HP. Your hp: ${state.hp}.`,'bad');
        playSound('hurt'); checkDead();
      }
      break;
    }
    case 'fight-prayer': {
      const roll=Math.ceil(Math.random()*6)+1;
      if(roll>=3){
        state.kills++; state.score+=90; state.karma+=20; state.soulsSaved++;
        addLog('‚õ©Ô∏è Sacred prayer banishes the Oni! +90 pts. +20 Light Karma.','good');
        checkBondProgress();
      } else {
        state.hp-=10; addLog('üôè The prayer weakened it but could not banish it. -10 HP.','bad');
      }
      break;
    }
    case 'flee': {
      const dmg=Math.floor(Math.random()*12)+5;
      state.hp-=dmg; state.karma-=8; state.score+=10;
      addLog(`üèÉ You flee the Oni. -${dmg} HP, -8 Karma. The village remembers nothing.`,'bad');
      checkDead(); break;
    }

    case 'chest-open': {
      const lucky=Math.random();
      if(lucky>0.2){ giveItem(); state.chestOpened=(state.chestOpened||0)+1; state.score+=80; addLog('üì¶ The chest was filled with warmth. Loot acquired! +80 pts.','special'); playSound('loot'); }
      else { const dmg=18; state.hp-=dmg; addLog(`üí• Trap chest! -${dmg} HP. The Oni knew you were coming.`,'bad'); checkDead(); }
      break;
    }
    case 'chest-safe': {
      giveItem(); state.score+=60; addLog('üì¶ Examined safely. Loot acquired. +60 pts.','special'); playSound('loot'); break;
    }

    case 'shrine': {
      const heal=state.karma>=0?25:15;
      state.hp=Math.min(state.maxHp,state.hp+heal);
      state.karma+=12; state.shrines++; state.score+=50;
      const combatBonus=state.karma>0;
      addLog(`‚õ©Ô∏è Prayers answered. +${heal} HP restored. +12 Light Karma.${combatBonus?' Next combat: +1 roll bonus.':''}`,'good');
      playSound('shrine'); break;
    }

    case 'portal': {
      const jump=(Math.random()>0.3?1:-1)*(Math.floor(Math.random()*4)+2);
      const newPos=Math.max(0,Math.min(24,state.position+jump));
      state.position=newPos; MAP_NODES[newPos].visited=true;
      state.portals++; state.score+=35;
      addLog(`üåÄ The portal carries you ${Math.abs(jump)} nodes ${jump>0?'forward':'backward'}. +35 pts.`,jump>0?'good':'neutral');
      renderMap(); break;
    }

    case 'curse': {
      const dmg=state.playerClass==='ryuujin'?10:Math.floor(Math.random()*10)+15;
      state.hp-=dmg; state.karma-=5;
      addLog(`üíÄ The curse bites deep. -${dmg} HP. Mugen's mark is on you.`,'bad');
      checkDead(); break;
    }
    case 'curse-resist': {
      const roll=Math.ceil(Math.random()*6);
      const dmg=roll>=4? 5 : (state.playerClass==='ryuujin'?10:18);
      state.hp-=dmg; state.score+=20;
      addLog(`üí™ You resist the hex. Roll: ${roll}. -${dmg} HP. +20 pts for your courage.`,roll>=4?'good':'bad');
      checkDead(); break;
    }

    case 'scroll': {
      const heal=10; state.hp=Math.min(state.maxHp,state.hp+heal);
      state.score+=40; state.karma+=8;
      addLog(`üìú Her words heal your spirit. +${heal} HP, +40 pts, +8 Light Karma.`,'spirit-log');
      break;
    }

    case 'relic': {
      state.relicsFound++;
      const relicItems=[
        {icon:'üîî',name:'Bell of Parting'},{icon:'ü™û',name:'Mirror of Souls'},
        {icon:'ü™≠',name:'Fan of Winds'},{icon:'‚ö±Ô∏è',name:'Soul Urn'},
        {icon:'ü™¨',name:'Spirit Talisman'},
      ];
      const ritem=relicItems[state.relicsFound-1]||relicItems[0];
      if(state.inventory.length<8) state.inventory.push(ritem);
      state.score+=150;
      if(state.gameMode==='relic'&&state.relicsFound<=5){
        state.objectives[state.relicsFound-1].done=true;
        addLog(`‚ö±Ô∏è Relic ${state.relicsFound}/5 collected: ${ritem.name}! +150 pts.`,'special');
        if(state.relicsFound>=5){setTimeout(triggerWin,600); return;}
      } else {
        addLog(`‚ö±Ô∏è Sacred relic found: ${ritem.name}! +150 pts.`,'special');
      }
      renderObjectives(); renderInventory(); break;
    }

    case 'gameover': triggerGameOver(); return;
  }

  // Spirit vigil ‚Äî every 5 turns save a soul
  if(state.gameMode==='spirit'&&state.turn%5===0){
    state.soulsSaved++; state.score+=60;
    addLog(`üïØÔ∏è Your vigil saves another soul from the void. ${state.soulsSaved} souls returned!`,'spirit-log');
  }

  // Check survival win
  if(state.gameMode==='spirit'&&state.turn>=state.turnLimit){
    state.objectives[0].done=true; renderObjectives();
    setTimeout(triggerWin,600); return;
  }

  updateStats(); renderInventory(); renderObjectives(); renderRerolls(); renderMap();
}

function checkBondProgress() {
  if(state.gameMode!=='bond') return;
  if(state.kills>=1&&!state.objectives[0].done){ state.objectives[0].done=true; state.soulFragments++; addLog('üå∏ Fragment of Memory recovered! She remembers your face.','spirit-log'); }
  if(state.kills>=3&&!state.objectives[1].done){ state.objectives[1].done=true; state.soulFragments++; addLog('üå∏ Fragment of Love recovered! She remembers what warmth feels like.','spirit-log'); }
  renderObjectives(); updateStats();
}

function checkWinCondition() {
  if(state.gameMode==='bond') return state.soulFragments>=2;
  if(state.gameMode==='relic') return state.relicsFound>=5;
  if(state.gameMode==='spirit') return state.turn>=state.turnLimit;
  return false;
}

function giveItem() {
  const items=[
    {icon:'üíä',name:'Spirit Herb'},{icon:'‚ö°',name:'Ki Stone'},
    {icon:'üõ°Ô∏è',name:'Jade Armor'},{icon:'üå∏',name:'Soul Petal'},
    {icon:'üîÆ',name:'Void Bead'},{icon:'üéã',name:'Bamboo Ward'},
    {icon:'üßß',name:'Lucky Charm'},{icon:'üïØÔ∏è',name:'Vigil Candle'},
  ];
  const item=items[Math.floor(Math.random()*items.length)];
  if(['Spirit Herb','Ki Stone'].includes(item.name)){
    const heal=item.name==='Spirit Herb'?18:10;
    state.hp=Math.min(state.maxHp,state.hp+heal);
    addLog(`üíä ${item.name} restores ${heal} HP.`,'good');
  }
  if(state.inventory.length<8) state.inventory.push(item);
}

function checkDead() {
  updateStats();
  if(state.hp<=0){ state.hp=0; state.gameOver=true; setTimeout(triggerGameOver,900); }
}

// ============================
// WIN / LOSE
// ============================
const WIN_EPILOGUE = `<p>As your final action sends the last fragment of her spirit free, the sky above the spirit realm cracks open like an old wound finally allowed to heal.</p>
<br><p>The Soul Tree ‚Äî grey and leafless for three long years ‚Äî exhales. A single petal unfurls. Then another. Then a thousand. Then a million ‚Äî all at once, like a held breath finally released.</p>
<br><p>You hear her voice for the first time. It sounds like something you have always known but never found the word for. She says your name ‚Äî your real name, the one written in the bark of the Soul Tree long before you were born.</p>
<br><p><em>"You came,"</em> she says. <em>"I was not sure anyone would."</em></p>
<br><p>Every soul that Mugen had swallowed returns ‚Äî not as ghosts, but as light. They land on rooftops and in open palms and in the empty places in people's chests. Children wake from their long sleep. Elders draw breath. The lanterns relight themselves.</p>
<br><p>And you ‚Äî the Tamashii-Keeper, the last one marked ‚Äî sit down beneath the blooming Soul Tree, and for the first time in this journey, you feel something you had almost forgotten the shape of.</p>
<br><p style="color:var(--sakura);font-style:italic;text-align:center;">You feel at home.</p>`;

const GAMEOVER_WHAT_HAPPENS = `<p>Without the Tamashii-Keeper, the Soul Tree's last leaf falls at dawn on the third day.</p>
<br><p>People do not die dramatically. They simply... thin. Their laughter becomes quieter. Their memories shorter. A grandmother forgets her grandchild's name ‚Äî not cruelly, but gently, like sand through open fingers.</p>
<br><p>The Goddess remains imprisoned inside Mugen-Oni. He grows enormous ‚Äî not with joy, but with the hollow fullness of something that consumes without ever being satisfied. He does not gloat. He does not celebrate. He simply <em>is</em> ‚Äî an endless, hungry dark where a god of love used to stand.</p>
<br><p>The lanterns no longer float into the sky each autumn. No one is sure why the tradition stopped. They just... stopped making them.</p>
<br><p>And somewhere, in the last intact corner of the spirit realm, a small wooden shrine stands untended. Its offering bowl is empty. Its candle has been cold for a very long time. On the stone, barely legible, someone once carved four words in ancient script:</p>
<br><p style="color:var(--sakura);font-style:italic;text-align:center;font-size:1.1rem;">"Please. Someone. Come."</p>
<br><p style="opacity:0.5;font-style:italic;text-align:center;">The dice remain on the table. They can be rolled again.</p>`;

function triggerWin() {
  state.gameOver=true;
  const bonus=state.hp*2+state.kills*50+state.shrines*30;
  state.score+=bonus;
  spawnPetalBurst();
  playSound('victory');

  const badges={'bond':'üå∏','relic':'‚ö±Ô∏è','spirit':'üïØÔ∏è'};
  const titles={'bond':'The Goddess Breathes Again','relic':'The Relics Reunited','spirit':'The Vigil Held True'};
  document.getElementById('win-badge').textContent=badges[state.gameMode];
  document.getElementById('win-title').textContent=titles[state.gameMode];
  document.getElementById('final-score').textContent=state.score.toLocaleString();
  document.getElementById('win-epilogue').innerHTML=`<h3>‚ú¶ EPILOGUE ‚Äî WHAT HAPPENED</h3>${WIN_EPILOGUE}`;
  document.getElementById('win-stats-block').innerHTML=`
    ${mkStat(state.kills,'Oni Vanquished','#ff9aaa')}
    ${mkStat(state.shrines,'Shrines Blessed','var(--teal-light)')}
    ${mkStat(state.soulsSaved,'Souls Saved','var(--gold-light)')}
    ${mkStat(state.turn,'Turns Taken','var(--sakura)')}
  `;
  showScreen('win-screen');
}

function mkStat(val,label,color){
  return `<div style="text-align:center"><div style="font-family:'Cinzel Decorative',serif;font-size:1.6rem;color:${color}">${val}</div><div style="font-family:'Cinzel Decorative',serif;font-size:0.55rem;color:rgba(201,147,58,0.4);letter-spacing:0.2em">${label}</div></div>`;
}

function triggerGameOver() {
  state.gameOver=true;
  document.getElementById('gameover-score').textContent=state.score.toLocaleString();
  document.getElementById('gameover-epilogue').innerHTML=`<h3 style="color:#ff9aaa;">‚ú¶ WHAT WILL HAPPEN ‚Äî IF NO ONE COMES</h3>${GAMEOVER_WHAT_HAPPENS}`;
  showScreen('gameover-screen');
  playSound('gameover');
}

function restart() { selClass=''; selMode=''; showScreen('intro-screen'); }

// ============================
// SOUND
// ============================
let ctx;
function getCtx(){ if(!ctx) ctx=new(window.AudioContext||window.webkitAudioContext)(); return ctx; }
function tone(f,t,d,v=0.12,delay=0){
  try{
    const c=getCtx(),o=c.createOscillator(),g=c.createGain();
    o.connect(g); g.connect(c.destination);
    o.type=t; o.frequency.value=f;
    g.gain.setValueAtTime(0,c.currentTime+delay);
    g.gain.linearRampToValueAtTime(v,c.currentTime+delay+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+delay+d);
    o.start(c.currentTime+delay); o.stop(c.currentTime+delay+d+0.05);
  }catch(e){}
}
function playSound(s){
  switch(s){
    case 'roll':    for(let i=0;i<8;i++) tone(180+i*40,'triangle',0.06,0.07,i*0.04); break;
    case 'oni':     tone(60,'sawtooth',0.5,0.25); tone(80,'square',0.3,0.2,0.1); break;
    case 'chest':   tone(392,'sine',0.2,0.1); tone(523,'sine',0.2,0.1,0.12); tone(659,'sine',0.3,0.1,0.24); break;
    case 'shrine':  [392,494,587,784].forEach((f,i)=>tone(f,'sine',0.3,0.09,i*0.1)); break;
    case 'scroll':  tone(523,'sine',0.25,0.1); tone(659,'sine',0.2,0.08,0.15); break;
    case 'win':     tone(523,'sine',0.2,0.15); tone(659,'sine',0.15,0.12,0.1); tone(784,'sine',0.12,0.1,0.2); break;
    case 'victory': [392,494,587,740,880,1047].forEach((f,i)=>tone(f,'sine',0.4,0.12,i*0.1)); break;
    case 'hurt':    tone(100,'sawtooth',0.35,0.2); tone(80,'sawtooth',0.25,0.15,0.08); break;
    case 'loot':    tone(784,'sine',0.15,0.1); tone(988,'sine',0.1,0.08,0.1); break;
    case 'curse':   tone(55,'sawtooth',0.4,0.25); tone(65,'square',0.2,0.2,0.1); break;
    case 'select':  tone(660,'sine',0.08,0.08); break;
    case 'hint':    tone(440,'triangle',0.1,0.07); break;
    case 'startup': [262,330,392,523,659].forEach((f,i)=>tone(f,'sine',0.25,0.1,i*0.09)); break;
    case 'gameover':tone(196,'sawtooth',0.6,0.15); tone(146,'square',0.4,0.12,0.2); break;
  }
}

// ============================
// PETALS AMBIENT
// ============================
function spawnAmbientPetals(){
  const layer=document.getElementById('petal-layer');
  const petals=['üå∏','üå∫','üçÉ','‚úø','‚ùÄ'];
  for(let i=0;i<20;i++){
    const p=document.createElement('div');
    p.className='petal';
    p.textContent=petals[Math.floor(Math.random()*petals.length)];
    p.style.cssText=`left:${Math.random()*100}%;animation-duration:${8+Math.random()*12}s;animation-delay:${Math.random()*10}s;font-size:${0.6+Math.random()*0.8}rem;`;
    layer.appendChild(p);
  }
}

function spawnPetalBurst(){
  const burst=document.getElementById('petal-burst');
  burst.innerHTML='';
  const colors=['#ffb7c5','#e8556a','#c9933a','#f0c060','#d7aef5'];
  for(let i=0;i<60;i++){
    const p=document.createElement('div');
    p.className='burst-petal';
    p.textContent=['üå∏','üå∫','‚úø','‚ùÄ','üåº'][Math.floor(Math.random()*5)];
    p.style.cssText=`left:${Math.random()*100}%;top:${-10+Math.random()*20}%;font-size:${0.8+Math.random()*1.2}rem;animation:burstFall ${2+Math.random()*4}s ${Math.random()*2}s linear forwards;`;
    burst.appendChild(p);
  }
}

// INIT
spawnAmbientPetals();
</script>
</body>
</html>
