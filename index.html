<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAMASHII 3D ‚Äî The Last Soul Chronicle</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Noto+Serif+JP:wght@300;400;700&display=swap');
:root{
  --sakura:#ffb7c5;--sakura2:#e8556a;--ink:#0d0508;--gold:#c9933a;
  --gold2:#f0c060;--spirit:#9b59b6;--spirit2:#d7aef5;--teal:#1abc9c;
  --teal2:#aff0e0;--paper:#fdf3e7;--red:#ff4466;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--ink);color:var(--paper);font-family:'Noto Serif JP',serif;overflow:hidden;width:100vw;height:100vh;}
#three-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;}
.screen{position:fixed;inset:0;z-index:20;display:none;align-items:center;justify-content:center;flex-direction:column;}
.screen.active{display:flex;}

/* INTRO */
#intro-screen{background:radial-gradient(ellipse at center,rgba(155,89,182,0.18) 0%,rgba(13,5,8,0.97) 70%);text-align:center;padding:20px;}
.kanji-big{font-size:7rem;color:var(--sakura);filter:drop-shadow(0 0 40px rgba(255,183,197,0.7));animation:kFloat 4s ease-in-out infinite;line-height:1;display:block;}
@keyframes kFloat{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-18px) scale(1.05);}}
.title-main{font-family:'Cinzel Decorative',serif;font-size:clamp(2.2rem,5vw,4.5rem);font-weight:900;background:linear-gradient(135deg,var(--sakura),var(--gold2),var(--spirit2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:0.08em;margin:8px 0 4px;}
.title-sub{font-family:'Cinzel Decorative',serif;font-size:0.75rem;letter-spacing:0.5em;color:var(--sakura);opacity:0.55;text-transform:uppercase;margin-bottom:20px;}
.story-scroll{max-width:620px;background:rgba(253,243,231,0.04);border:1px solid rgba(201,147,58,0.25);border-radius:6px;padding:28px 30px;margin:0 auto 24px;text-align:left;position:relative;overflow:hidden;}
.story-scroll::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0.5;}
.story-scroll p{font-size:0.88rem;line-height:1.9;color:rgba(253,243,231,0.8);}
.story-scroll p+p{margin-top:12px;}
.em{color:var(--sakura);font-weight:700;}.gd{color:var(--gold2);font-weight:700;}.rd{color:var(--red);font-weight:700;}.sp{color:var(--spirit2);font-weight:700;}

/* CHAR CREATE */
#char-screen{background:rgba(13,5,8,0.96);backdrop-filter:blur(10px);overflow-y:auto;align-items:flex-start;padding:30px 16px;}
#char-screen .inner{max-width:900px;width:100%;margin:0 auto;}
.section-head{font-family:'Cinzel Decorative',serif;font-size:0.7rem;letter-spacing:0.4em;color:var(--gold2);text-transform:uppercase;margin-bottom:14px;opacity:0.8;}
.panel{background:rgba(255,183,197,0.03);border:1px solid rgba(201,147,58,0.18);border-radius:6px;padding:20px;margin-bottom:16px;position:relative;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(201,147,58,0.4),transparent);}
input[type=text]{width:100%;background:rgba(253,243,231,0.04);border:1px solid rgba(201,147,58,0.25);border-radius:4px;padding:14px 16px;color:var(--gold2);font-family:'Cinzel Decorative',serif;font-size:0.95rem;letter-spacing:0.1em;outline:none;transition:all 0.3s;margin-bottom:4px;}
input[type=text]:focus{border-color:var(--gold);box-shadow:0 0 16px rgba(201,147,58,0.2);}
input::placeholder{color:rgba(201,147,58,0.3);}
.class-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;}
.cls-card{border:1px solid rgba(201,147,58,0.18);border-radius:6px;padding:16px 12px;cursor:pointer;text-align:center;transition:all 0.3s;background:rgba(13,5,8,0.6);}
.cls-card:hover,.cls-card.sel{border-color:var(--sakura);background:rgba(255,183,197,0.07);transform:translateY(-4px);box-shadow:0 8px 24px rgba(255,100,130,0.15);}
.cls-card.sel::after{content:'CHOSEN';position:absolute;top:6px;right:8px;font-family:'Cinzel Decorative',serif;font-size:0.5rem;color:var(--gold2);}
.cls-card{position:relative;}
.cls-icon{font-size:2.6rem;display:block;margin-bottom:8px;}.cls-name{font-family:'Cinzel Decorative',serif;font-size:0.65rem;color:var(--sakura);letter-spacing:0.2em;margin-bottom:4px;}.cls-jp{font-size:1rem;color:var(--gold);opacity:0.4;margin-bottom:6px;}.cls-desc{font-size:0.7rem;color:rgba(253,243,231,0.5);line-height:1.5;}.cls-abil{font-size:0.65rem;color:var(--spirit2);margin-top:6px;font-style:italic;}
.mode-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
.mode-card{border:1px solid rgba(201,147,58,0.18);border-radius:6px;padding:18px 14px;cursor:pointer;text-align:center;transition:all 0.3s;background:rgba(13,5,8,0.6);}
.mode-card:hover{transform:translateY(-4px);}
.mode-card.bond:hover{border-color:var(--sakura);box-shadow:0 8px 24px rgba(255,100,130,0.2);}
.mode-card.relic:hover{border-color:var(--gold2);box-shadow:0 8px 24px rgba(240,192,96,0.2);}
.mode-card.spirit:hover{border-color:var(--spirit2);box-shadow:0 8px 24px rgba(155,89,182,0.2);}
.mode-card.sel{border-color:var(--gold2)!important;background:rgba(201,147,58,0.07);}
.mode-icon{font-size:2.8rem;display:block;margin-bottom:10px;}.mode-title{font-family:'Cinzel Decorative',serif;font-size:0.75rem;letter-spacing:0.2em;margin-bottom:8px;}
.bond .mode-title{color:var(--sakura);}.relic .mode-title{color:var(--gold2);}.spirit .mode-title{color:var(--spirit2);}
.mode-desc{font-size:0.75rem;color:rgba(253,243,231,0.5);line-height:1.5;}

/* BUTTONS */
.btn{font-family:'Cinzel Decorative',serif;font-size:0.72rem;letter-spacing:0.18em;padding:12px 26px;border:1px solid rgba(255,183,197,0.3);background:transparent;color:var(--sakura);cursor:pointer;transition:all 0.3s;border-radius:3px;margin:5px;position:relative;overflow:hidden;}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,183,197,0.1),transparent);transition:left 0.35s;}
.btn:hover::before{left:100%;}
.btn:hover{border-color:var(--sakura);box-shadow:0 0 18px rgba(255,183,197,0.25);transform:translateY(-2px);}
.btn-gold{border-color:rgba(201,147,58,0.4);color:var(--gold2);}.btn-gold:hover{border-color:var(--gold2);box-shadow:0 0 18px rgba(240,192,96,0.3);}
.btn-spirit{border-color:rgba(155,89,182,0.4);color:var(--spirit2);}.btn-spirit:hover{border-color:var(--spirit2);box-shadow:0 0 18px rgba(155,89,182,0.3);}
.btn-teal{border-color:rgba(26,188,156,0.4);color:var(--teal2);}.btn-teal:hover{border-color:var(--teal2);box-shadow:0 0 18px rgba(26,188,156,0.3);}
.btn-danger{border-color:rgba(255,68,102,0.4);color:#ff8899;}.btn-danger:hover{border-color:#ff4466;box-shadow:0 0 18px rgba(255,68,102,0.3);}
.btn-lg{font-size:0.9rem;padding:16px 44px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CINEMATIC DICE ROLL SEQUENCE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#dice-cinema{
  position:fixed;inset:0;z-index:100;
  display:none;align-items:center;justify-content:center;
  flex-direction:column;
  background:radial-gradient(ellipse at center, rgba(13,5,8,0.0) 0%, rgba(13,5,8,0.0) 100%);
  pointer-events:none;
}
#dice-cinema.active{display:flex;}

/* Dark overlay that fades in */
.cinema-overlay{
  position:fixed;inset:0;z-index:99;
  background:rgba(13,5,8,0.0);
  transition:background 0.4s ease;
  pointer-events:none;
}
.cinema-overlay.dark{background:rgba(13,5,8,0.88);}

/* Swirling spirit energy ring */
#spirit-ring{
  position:absolute;width:300px;height:300px;
  border-radius:50%;
  background:transparent;
  border:2px solid transparent;
  box-shadow: 0 0 0 0 transparent;
  animation:none;
  opacity:0;
  transition:opacity 0.3s;
}
#spirit-ring.active{
  opacity:1;
  animation:spiralRing 1.5s ease-in-out infinite;
  border-color: rgba(155,89,182,0.5);
  box-shadow:
    0 0 30px rgba(155,89,182,0.4),
    0 0 60px rgba(255,183,197,0.2),
    inset 0 0 30px rgba(155,89,182,0.15);
}
@keyframes spiralRing{
  0%{transform:scale(0.8) rotate(0deg);border-color:rgba(155,89,182,0.3);}
  50%{transform:scale(1.1) rotate(180deg);border-color:rgba(255,183,197,0.6);box-shadow:0 0 50px rgba(255,183,197,0.4),0 0 100px rgba(155,89,182,0.2),inset 0 0 50px rgba(155,89,182,0.2);}
  100%{transform:scale(0.8) rotate(360deg);border-color:rgba(155,89,182,0.3);}
}

/* Second outer ring */
#spirit-ring2{
  position:absolute;width:400px;height:400px;
  border-radius:50%;
  background:transparent;
  border:1px solid transparent;
  opacity:0;
  transition:opacity 0.4s;
}
#spirit-ring2.active{
  opacity:0.5;
  animation:spiralRing2 2s ease-in-out infinite reverse;
  border-color:rgba(240,192,96,0.3);
  box-shadow:0 0 20px rgba(240,192,96,0.2);
}
@keyframes spiralRing2{
  0%,100%{transform:scale(0.9) rotate(0deg);}
  50%{transform:scale(1.05) rotate(180deg);}
}

/* Sakura petals burst during roll */
.cinema-petal{
  position:absolute;font-size:1.2rem;
  animation:cinemaPetalFly linear forwards;
  pointer-events:none;opacity:0;
}
@keyframes cinemaPetalFly{
  0%{opacity:0;transform:translate(0,0) rotate(0deg) scale(0);}
  15%{opacity:1;transform:translate(var(--tx1),var(--ty1)) rotate(90deg) scale(1.2);}
  85%{opacity:0.4;transform:translate(var(--tx2),var(--ty2)) rotate(360deg) scale(0.8);}
  100%{opacity:0;transform:translate(var(--tx3),var(--ty3)) rotate(540deg) scale(0);}
}

/* The big cinematic dice */
#cinema-dice-wrap{
  position:relative;
  z-index:101;
  display:flex;
  align-items:center;
  justify-content:center;
}
#cinema-dice{
  width:140px;height:140px;
  background:linear-gradient(135deg,rgba(20,8,16,0.95),rgba(40,15,30,0.9));
  border:3px solid rgba(201,147,58,0.7);
  border-radius:24px;
  display:flex;align-items:center;justify-content:center;
  font-family:'Cinzel Decorative',serif;
  font-size:4rem;font-weight:900;
  color:var(--gold2);
  box-shadow:
    0 0 40px rgba(201,147,58,0.35),
    0 0 80px rgba(255,183,197,0.15),
    inset 0 0 30px rgba(201,147,58,0.1);
  transition:transform 0.1s;
  position:relative;
  overflow:hidden;
}
#cinema-dice::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,183,197,0.08) 0%,transparent 50%,rgba(155,89,182,0.08) 100%);
  pointer-events:none;
}
#cinema-dice.tumble{animation:diceTumble 0.06s ease-in-out;}
@keyframes diceTumble{
  0%{transform:rotate(-8deg) scale(0.95);}
  25%{transform:rotate(10deg) scale(1.08);}
  50%{transform:rotate(-6deg) scale(0.97);}
  75%{transform:rotate(8deg) scale(1.05);}
  100%{transform:rotate(0deg) scale(1);}
}
#cinema-dice.slam{animation:diceSlam 0.5s cubic-bezier(0.36,0.07,0.19,0.97);}
@keyframes diceSlam{
  0%{transform:scale(0.5) translateY(-60px);opacity:0;}
  40%{transform:scale(1.4) translateY(10px);opacity:1;}
  65%{transform:scale(0.9) translateY(-5px);}
  80%{transform:scale(1.1) translateY(2px);}
  100%{transform:scale(1) translateY(0);}
}

/* Result number glow */
#cinema-result-num{
  font-family:'Cinzel Decorative',serif;
  font-size:5rem;font-weight:900;
  color:var(--gold2);
  text-shadow:0 0 30px rgba(240,192,96,0.8),0 0 60px rgba(240,192,96,0.4);
  opacity:0;
  transform:scale(0.5);
  transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);
  margin-top:10px;
}
#cinema-result-num.show{opacity:1;transform:scale(1);}

/* Cinema label */
#cinema-label{
  font-family:'Cinzel Decorative',serif;
  font-size:0.65rem;letter-spacing:0.4em;
  color:rgba(255,183,197,0.5);
  text-transform:uppercase;
  margin-top:8px;
  opacity:0;
  transition:opacity 0.4s;
}
#cinema-label.show{opacity:1;}

/* Result reveal text */
#cinema-event-text{
  position:absolute;bottom:80px;
  font-family:'Cinzel Decorative',serif;
  font-size:1.1rem;letter-spacing:0.2em;
  text-align:center;
  max-width:400px;
  opacity:0;
  transform:translateY(20px);
  transition:all 0.6s ease;
  color:var(--sakura);
  text-shadow:0 0 20px rgba(255,183,197,0.5);
}
#cinema-event-text.show{opacity:1;transform:translateY(0);}

/* Shockwave pulse on result */
.shockwave{
  position:absolute;
  width:140px;height:140px;
  border-radius:24px;
  border:3px solid rgba(240,192,96,0.8);
  animation:shockPulse 0.8s ease-out forwards;
  pointer-events:none;
}
@keyframes shockPulse{
  0%{transform:scale(1);opacity:1;border-width:4px;}
  100%{transform:scale(2.5);opacity:0;border-width:1px;}
}
.shockwave2{
  position:absolute;
  width:140px;height:140px;
  border-radius:24px;
  border:2px solid rgba(255,183,197,0.6);
  animation:shockPulse 0.8s 0.15s ease-out forwards;
  pointer-events:none;
}

/* SPIRIT SLASH effect for Kenshi crit */
.spirit-slash{
  position:absolute;
  width:200%;height:8px;
  background:linear-gradient(90deg,transparent,rgba(255,183,197,0.9),rgba(255,255,255,0.8),rgba(255,183,197,0.9),transparent);
  animation:slashAcross 0.35s ease-out forwards;
  pointer-events:none;
}
@keyframes slashAcross{
  0%{transform:translateX(-100%) rotate(-15deg);opacity:1;}
  100%{transform:translateX(100%) rotate(-15deg);opacity:0;}
}
.spirit-slash2{
  position:absolute;
  width:200%;height:5px;
  background:linear-gradient(90deg,transparent,rgba(155,89,182,0.7),rgba(255,255,255,0.5),rgba(155,89,182,0.7),transparent);
  animation:slashAcross 0.35s 0.08s ease-out forwards;
  pointer-events:none;
  top:8px;
}

/* CRITICAL FLASH */
.crit-flash{
  position:fixed;inset:0;z-index:102;
  background:rgba(255,183,197,0.15);
  animation:critFlash 0.5s ease-out forwards;
  pointer-events:none;
}
@keyframes critFlash{0%{opacity:1;}100%{opacity:0;}}

/* ROLL LABEL TYPE-REVEAL */
#cinema-roll-label{
  position:absolute;top:60px;
  font-family:'Cinzel Decorative',serif;
  font-size:0.6rem;letter-spacing:0.5em;
  color:rgba(255,183,197,0.4);
  text-transform:uppercase;
  opacity:0;
  animation:none;
}
#cinema-roll-label.show{animation:fadeLabel 0.4s ease forwards;}
@keyframes fadeLabel{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* HUD */
#hud{position:fixed;top:0;left:0;right:0;z-index:30;pointer-events:none;display:none;}
#hud.active{pointer-events:auto;display:block;}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start;padding:14px 18px;gap:12px;flex-wrap:wrap;}
.hud-panel{background:rgba(13,5,8,0.82);border:1px solid rgba(201,147,58,0.2);border-radius:6px;padding:10px 14px;backdrop-filter:blur(8px);}
.hud-name{font-family:'Cinzel Decorative',serif;font-size:0.8rem;color:var(--gold2);letter-spacing:0.1em;}
.hud-class{font-size:0.75rem;color:rgba(255,183,197,0.5);margin-top:2px;}
.hud-avatar{font-size:1.6rem;margin-right:8px;vertical-align:middle;}
.hp-wrap{display:flex;flex-direction:column;gap:4px;min-width:130px;}
.hp-label{display:flex;justify-content:space-between;font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.2em;color:rgba(201,147,58,0.5);}
.hp-track{height:10px;background:rgba(255,255,255,0.07);border-radius:5px;overflow:hidden;position:relative;}
.hp-fill{height:100%;border-radius:5px;transition:width 0.5s cubic-bezier(.16,1,.3,1);background:linear-gradient(90deg,#ff4466,var(--sakura));}
.hp-heal-glow{position:absolute;inset:0;background:rgba(26,188,156,0.5);border-radius:5px;opacity:0;transition:opacity 0.3s;pointer-events:none;}
.hp-track.healing .hp-heal-glow{animation:healFlash 0.6s ease forwards;}
@keyframes healFlash{0%{opacity:0.8;}100%{opacity:0;}}
.stat-row{display:flex;gap:16px;}
.stat-box{text-align:center;}
.stat-lbl{font-family:'Cinzel Decorative',serif;font-size:0.5rem;letter-spacing:0.15em;color:rgba(201,147,58,0.45);}
.stat-val{font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--gold2);}
.karma-wrap{min-width:110px;}
.karma-track{height:6px;background:rgba(255,255,255,0.06);border-radius:3px;position:relative;overflow:hidden;margin-top:4px;}
.karma-light{position:absolute;top:0;left:50%;height:100%;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:0 3px 3px 0;transition:width 0.5s;}
.karma-dark{position:absolute;top:0;right:50%;height:100%;background:linear-gradient(90deg,#ff4466,#8b0030);border-radius:3px 0 0 3px;transition:width 0.5s;}

/* BOTTOM HUD */
#hud-bottom{position:fixed;bottom:0;left:0;right:0;z-index:30;display:none;justify-content:space-between;align-items:flex-end;padding:14px 18px;pointer-events:none;}
#hud-bottom.active{pointer-events:auto;display:flex;}

/* DICE AREA */
.dice-area{display:flex;flex-direction:column;align-items:center;gap:6px;}
.dice-3d{width:80px;height:80px;cursor:pointer;position:relative;pointer-events:auto;transform-style:preserve-3d;transition:transform 0.15s;}
.dice-3d:hover{transform:scale(1.08) rotateY(15deg) rotateX(-10deg);}
.dice-face{width:80px;height:80px;background:linear-gradient(135deg,rgba(201,147,58,0.2),rgba(155,89,182,0.15));border:2px solid rgba(201,147,58,0.6);border-radius:14px;display:flex;align-items:center;justify-content:center;font-family:'Cinzel Decorative',serif;font-size:2rem;font-weight:900;color:var(--gold2);box-shadow:0 0 20px rgba(201,147,58,0.2),inset 0 0 20px rgba(201,147,58,0.05);user-select:none;}
.dice-lbl{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.25em;color:rgba(201,147,58,0.4);text-align:center;pointer-events:none;}
.action-btns{display:flex;flex-direction:column;gap:5px;pointer-events:auto;}
.action-btns .btn{padding:8px 16px;font-size:0.6rem;}
.hint-panel{background:rgba(13,5,8,0.88);border:1px solid rgba(155,89,182,0.28);border-radius:6px;padding:10px 14px;max-width:260px;font-size:0.75rem;color:var(--spirit2);line-height:1.6;pointer-events:auto;backdrop-filter:blur(8px);}
.hint-title{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.3em;color:rgba(155,89,182,0.6);margin-bottom:6px;display:block;}
.hint-next{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.2em;color:var(--spirit2);background:none;border:1px solid rgba(155,89,182,0.25);border-radius:2px;padding:4px 10px;cursor:pointer;margin-top:6px;width:100%;transition:all 0.2s;pointer-events:auto;}
.hint-next:hover{border-color:var(--spirit2);background:rgba(155,89,182,0.1);}
.life-panel{background:rgba(13,5,8,0.9);border:1px solid rgba(26,188,156,0.3);border-radius:6px;padding:10px 14px;max-width:200px;pointer-events:auto;backdrop-filter:blur(8px);}
.life-title{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.3em;color:rgba(26,188,156,0.6);margin-bottom:8px;display:block;}
.life-btn{display:flex;align-items:center;gap:8px;font-family:'Cinzel Decorative',serif;font-size:0.6rem;letter-spacing:0.1em;padding:7px 10px;border:1px solid rgba(26,188,156,0.25);border-radius:4px;background:rgba(26,188,156,0.05);color:var(--teal2);cursor:pointer;margin-bottom:5px;width:100%;transition:all 0.25s;text-align:left;}
.life-btn:hover:not(:disabled){border-color:var(--teal2);background:rgba(26,188,156,0.12);transform:translateX(3px);}
.life-btn:disabled{opacity:0.3;cursor:not-allowed;}
.life-btn .lbcost{margin-left:auto;color:var(--gold2);font-size:0.65rem;}
.obj-panel{background:rgba(13,5,8,0.88);border:1px solid rgba(201,147,58,0.18);border-radius:6px;padding:10px 14px;max-width:180px;pointer-events:auto;backdrop-filter:blur(8px);}
.obj-title{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.3em;color:rgba(201,147,58,0.5);margin-bottom:8px;display:block;}
.obj-item{font-size:0.72rem;color:rgba(253,243,231,0.5);margin-bottom:5px;display:flex;gap:6px;align-items:flex-start;line-height:1.4;}
.obj-item.done{color:rgba(26,188,156,0.6);text-decoration:line-through;opacity:0.7;}
.obj-dot{color:var(--sakura);font-size:0.85rem;min-width:14px;}
.prog-wrap{margin-top:6px;}
.prog-bar{height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--spirit),var(--sakura));transition:width 0.5s;}
.prog-lbl{display:flex;justify-content:space-between;font-family:'Cinzel Decorative',serif;font-size:0.5rem;color:rgba(201,147,58,0.35);margin-top:2px;}

/* LOG */
#log-feed{position:fixed;left:18px;top:50%;transform:translateY(-50%);z-index:30;max-width:200px;pointer-events:none;}
.log-item{background:rgba(13,5,8,0.82);border:1px solid rgba(201,147,58,0.15);border-radius:4px;padding:7px 10px;font-size:0.72rem;margin-bottom:5px;backdrop-filter:blur(6px);animation:logIn 0.3s ease,logOut 0.4s ease 3.5s forwards;line-height:1.5;}
@keyframes logIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:translateX(0);}}
@keyframes logOut{to{opacity:0;transform:translateX(-10px);}}
.li-good{color:var(--teal2);border-color:rgba(26,188,156,0.2);}.li-bad{color:#ff8899;border-color:rgba(255,68,102,0.2);}.li-special{color:var(--gold2);border-color:rgba(201,147,58,0.2);}.li-spirit{color:var(--spirit2);border-color:rgba(155,89,182,0.2);}.li-heal{color:#88ffcc;border-color:rgba(100,255,200,0.25);}

/* MODAL */
.modal-bg{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;animation:mFadeIn 0.3s ease;}
@keyframes mFadeIn{from{opacity:0;}to{opacity:1;}}
.modal-bg.open{display:flex;}
.modal-box{background:linear-gradient(135deg,#0d0508,#160a10);border:1px solid rgba(201,147,58,0.3);border-radius:8px;padding:28px;max-width:480px;width:92%;box-shadow:0 0 80px rgba(255,100,130,0.12),0 0 40px rgba(201,147,58,0.08);position:relative;overflow:hidden;}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),var(--sakura),transparent);opacity:0.6;}
.modal-badge{font-family:'Cinzel Decorative',serif;font-size:0.55rem;letter-spacing:0.4em;color:rgba(201,147,58,0.5);margin-bottom:8px;text-transform:uppercase;}
.modal-title{font-family:'Cinzel Decorative',serif;font-size:1.05rem;letter-spacing:0.1em;margin-bottom:3px;}
.modal-jp{font-size:0.9rem;opacity:0.3;margin-bottom:14px;font-family:'Noto Serif JP',serif;}
.modal-art{font-size:4rem;text-align:center;display:block;margin:8px 0;animation:artFloat 2.5s ease-in-out infinite;}
@keyframes artFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
.modal-desc{font-size:0.85rem;color:rgba(253,243,231,0.75);line-height:1.85;margin-bottom:14px;}
.modal-hint-box{background:rgba(155,89,182,0.07);border:1px solid rgba(155,89,182,0.2);border-radius:3px;padding:9px 12px;font-size:0.75rem;color:var(--spirit2);margin-bottom:16px;line-height:1.6;}
.modal-hint-box::before{content:'‚ü° Hint: ';font-weight:700;}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}

/* WIN / LOSE */
#win-screen,#lose-screen{background:rgba(13,5,8,0.97);backdrop-filter:blur(10px);overflow-y:auto;padding:30px;text-align:center;}
.win-badge{font-size:5rem;display:block;animation:wPulse 2s ease-in-out infinite;}
@keyframes wPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
.win-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.4rem,4vw,3rem);color:var(--gold2);filter:drop-shadow(0 0 20px rgba(240,192,96,0.5));margin:14px 0 6px;}
.score-big{font-family:'Cinzel Decorative',serif;font-size:3.5rem;color:var(--sakura);filter:drop-shadow(0 0 20px rgba(255,183,197,0.5));}
.epilogue-wrap{max-width:620px;margin:20px auto;background:rgba(253,243,231,0.03);border:1px solid rgba(201,147,58,0.2);border-radius:6px;padding:26px 22px;text-align:left;}
.epilogue-wrap h3{font-family:'Cinzel Decorative',serif;font-size:0.75rem;letter-spacing:0.3em;color:var(--gold2);margin-bottom:14px;}
.epilogue-wrap p{font-size:0.86rem;line-height:1.9;color:rgba(253,243,231,0.75);margin-bottom:10px;}

/* PETALS */
.petal-rain{position:fixed;inset:0;pointer-events:none;z-index:5;}
.petal{position:absolute;font-size:0.9rem;animation:petalFall linear infinite;opacity:0;}
@keyframes petalFall{0%{transform:translateY(-20px) rotate(0deg);opacity:0;}8%{opacity:0.7;}90%{opacity:0.25;}100%{transform:translateY(105vh) rotate(720deg);opacity:0;}}
.burst-petal{position:absolute;animation:bFall linear forwards;}
@keyframes bFall{0%{opacity:1;transform:translateY(0) rotate(0deg);}100%{opacity:0;transform:translateY(90vh) rotate(540deg);}}

/* NODE TOOLTIP */
#node-tooltip{position:fixed;z-index:35;background:rgba(13,5,8,0.9);border:1px solid rgba(201,147,58,0.3);border-radius:5px;padding:8px 12px;font-size:0.72rem;color:var(--gold2);pointer-events:none;display:none;font-family:'Cinzel Decorative',serif;letter-spacing:0.1em;backdrop-filter:blur(6px);}

/* HEAL FLASH */
#heal-flash{position:fixed;inset:0;z-index:45;pointer-events:none;background:radial-gradient(ellipse at center,rgba(26,188,156,0.3),transparent 70%);opacity:0;transition:opacity 0.2s;}
#heal-flash.show{animation:hFlash 0.7s ease forwards;}
@keyframes hFlash{0%{opacity:0;}30%{opacity:1;}100%{opacity:0;}}

/* Scroll in char screen */
#char-screen::-webkit-scrollbar{width:4px;}
#char-screen::-webkit-scrollbar-thumb{background:rgba(201,147,58,0.2);border-radius:2px;}
</style>
</head>
<body>

<!-- HEAL FLASH -->
<div id="heal-flash"></div>
<!-- TOOLTIP -->
<div id="node-tooltip"></div>
<!-- THREE.JS CANVAS -->
<canvas id="three-canvas"></canvas>
<!-- PETAL RAIN -->
<div class="petal-rain" id="petal-layer"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CINEMATIC DICE ROLL OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="cinema-overlay" id="cinema-overlay"></div>
<div id="dice-cinema">
  <div id="spirit-ring2"></div>
  <div id="spirit-ring"></div>
  <div id="cinema-roll-label">‚ü° The Dice of Fate ‚ü°</div>
  <div id="cinema-dice-wrap">
    <div id="cinema-dice">üé≤</div>
  </div>
  <div id="cinema-result-num"></div>
  <div id="cinema-label">SOUL POINTS AWARDED</div>
  <div id="cinema-event-text"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INTRO SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="intro-screen">
  <span class="kanji-big">È≠Ç</span>
  <div class="title-main">TAMASHII 3D</div>
  <div class="title-sub">The Last Soul Chronicle ¬∑ Three-Dimensional Edition</div>
  <div class="story-scroll">
    <p>In the age when the spirit realm and the mortal world breathed as one, a village named <span class="em">Hanenoi</span> floated paper lanterns each autumn into the sky ‚Äî prayers to the <span class="gd">Spirit Goddess Y≈´rei-no-Hana</span>, keeper of the ancient <span class="em">Soul Tree</span> whose blossoms held the boundary between life and death in perfect balance.</p>
    <p>Then came <span class="rd">the Night of Fallen Petals.</span> The tree withered. Children stopped laughing. Elders stopped breathing. The Goddess herself was imprisoned inside a corrupted demon ‚Äî <span class="sp">Mugen-Oni, the Endless One</span> ‚Äî who confused devotion with possession and turned it into a cage.</p>
    <p>You are the last <span class="gd">Tamashii-Keeper</span>. The dice of fate are before you. The 3D spirit realm stretches in every direction. <span class="em">Roll true, and perhaps she can still be saved.</span></p>
  </div>
  <button class="btn btn-gold btn-lg" onclick="showScreen('char-screen')">‚ú¶ BEGIN YOUR CHRONICLE ‚ú¶</button>
  <div style="margin-top:10px;font-size:0.75rem;color:rgba(201,147,58,0.3);letter-spacing:0.3em;">Âßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHARACTER SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="char-screen">
  <div class="inner">
    <div style="text-align:center;margin-bottom:20px;padding-top:10px;">
      <div style="font-family:'Cinzel Decorative',serif;font-size:clamp(1.2rem,3vw,2rem);color:var(--gold2);">Choose Your Path</div>
      <div style="font-size:0.85rem;color:rgba(255,183,197,0.4);margin-top:4px;">„Ç≠„É£„É©„ÇØ„Çø„Éº‰ΩúÊàê</div>
    </div>
    <div class="panel">
      <div class="section-head">‚ú¶ Your Spirit Name</div>
      <input type="text" id="nameInput" placeholder="Enter your name..." maxlength="18"/>
      <div style="font-size:0.72rem;color:rgba(201,147,58,0.35);font-style:italic;">This name will be carved into the Soul Tree forever.</div>
    </div>
    <div class="panel">
      <div class="section-head">‚ú¶ Spirit Class</div>
      <div class="class-grid">
        <div class="cls-card" onclick="pickClass('kenshi')" id="cls-kenshi">
          <span class="cls-icon">‚öîÔ∏è</span><div class="cls-name">Kenshi</div><div class="cls-jp">Ââ£Â£´</div>
          <div class="cls-desc">The Way of the Sword. Strong against Oni. Critical strike on rolls of 5-6.</div>
          <div class="cls-abil">‚òÖ Crits deal double damage</div>
        </div>
        <div class="cls-card" onclick="pickClass('miko')" id="cls-miko">
          <span class="cls-icon">‚õ©Ô∏è</span><div class="cls-name">Miko</div><div class="cls-jp">Â∑´Â•≥</div>
          <div class="cls-desc">Shrine Maiden. Can purify cursed tiles. Heals more from shrines.</div>
          <div class="cls-abil">‚òÖ Purify 3√ó per game</div>
        </div>
        <div class="cls-card" onclick="pickClass('kitsune')" id="cls-kitsune">
          <span class="cls-icon">ü¶ä</span><div class="cls-name">Kitsune</div><div class="cls-jp">Áãê</div>
          <div class="cls-desc">Nine-tailed trickster. Re-roll twice. Unpredictable and cunning.</div>
          <div class="cls-abil">‚òÖ Re-roll dice 2√ó per game</div>
        </div>
        <div class="cls-card" onclick="pickClass('ryuujin')" id="cls-ryuujin">
          <span class="cls-icon">üêâ</span><div class="cls-name">Ryuujin</div><div class="cls-jp">ÈæçÁ•û</div>
          <div class="cls-desc">Dragon descendant. Massive HP, half trap damage, regen on low rolls.</div>
          <div class="cls-abil">‚òÖ Dragon Scales: half trap dmg</div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="section-head">‚ú¶ Sacred Quest</div>
      <div class="mode-grid">
        <div class="mode-card bond" onclick="pickMode('bond')" id="mode-bond">
          <span class="mode-icon">üå∏</span><div class="mode-title">Bond of Souls</div>
          <div class="mode-desc">Find 3 spirit fragments of the Goddess within 20 turns. Emotional. Heartbreaking.</div>
        </div>
        <div class="mode-card relic" onclick="pickMode('relic')" id="mode-relic">
          <span class="mode-icon">‚ö±Ô∏è</span><div class="mode-title">Relic Hunt</div>
          <div class="mode-desc">Collect 5 sacred relics hidden in chests across the realm. Greed may corrupt you.</div>
        </div>
        <div class="mode-card spirit" onclick="pickMode('spirit')" id="mode-spirit">
          <span class="mode-icon">üïØÔ∏è</span><div class="mode-title">Spirit Vigil</div>
          <div class="mode-desc">Hold the light for 25 turns. Every turn you survive saves another lost soul.</div>
        </div>
      </div>
    </div>
    <div style="text-align:center;padding-bottom:20px;">
      <button class="btn btn-gold btn-lg" onclick="startGame()">‚ú¶ ENTER THE SPIRIT REALM ‚ú¶</button>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-top">
    <div class="hud-panel" style="display:flex;align-items:center;gap:10px;">
      <span class="hud-avatar" id="hud-avatar">?</span>
      <div><div class="hud-name" id="hud-name">‚Äî</div><div class="hud-class" id="hud-class">‚Äî</div></div>
    </div>
    <div class="hud-panel hp-wrap">
      <div class="hp-label"><span>LIFE FORCE</span><span id="hp-num">100</span></div>
      <div class="hp-track" id="hp-track">
        <div class="hp-fill" id="hp-fill" style="width:100%"></div>
        <div class="hp-heal-glow"></div>
      </div>
    </div>
    <div class="hud-panel stat-row">
      <div class="stat-box"><div class="stat-lbl">SOUL PTS</div><div class="stat-val" id="hud-score">0</div></div>
      <div class="stat-box"><div class="stat-lbl">TURN</div><div class="stat-val" id="hud-turn">1/20</div></div>
      <div class="stat-box"><div class="stat-lbl">ONI</div><div class="stat-val" id="hud-kills" style="color:#ff8899;">0</div></div>
    </div>
    <div class="hud-panel karma-wrap">
      <div class="stat-lbl" style="margin-bottom:2px;">KARMA ‚Äî <span id="karma-label" style="color:var(--gold2);">Neutral</span></div>
      <div class="karma-track">
        <div class="karma-light" id="karma-l" style="width:0%"></div>
        <div class="karma-dark" id="karma-d" style="width:0%"></div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM HUD -->
<div id="hud-bottom">
  <div>
    <div class="life-panel" id="life-panel">
      <span class="life-title">‚ú¶ LIFE RECOVERY</span>
      <button class="life-btn" id="lb-prayer" onclick="recoverLife('prayer')">üôè Pray at Shrine <span class="lbcost">+25 HP</span></button>
      <button class="life-btn" id="lb-herb" onclick="recoverLife('herb')">üåø Spirit Herb <span class="lbcost">+20 HP</span></button>
      <button class="life-btn" id="lb-dragon" onclick="recoverLife('dragon')">üêâ Dragon Breath <span class="lbcost">+35 HP</span></button>
      <button class="life-btn" id="lb-meditate" onclick="recoverLife('meditate')">üßò Meditate <span class="lbcost">+15 HP/3t</span></button>
      <button class="life-btn" id="lb-offer" onclick="recoverLife('offer')">üïØÔ∏è Soul Offering <span class="lbcost">+50 HP</span></button>
    </div>
  </div>
  <div class="dice-area">
    <div class="dice-3d" id="dice" onclick="rollDice()">
      <div class="dice-face" id="dice-face">üé≤</div>
    </div>
    <div class="dice-lbl">‚Äî Tap to Roll ‚Äî</div>
    <div class="action-btns" id="action-btns"></div>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
    <div class="obj-panel">
      <span class="obj-title">‚ú¶ OBJECTIVES</span>
      <div id="obj-list"></div>
      <div class="prog-wrap">
        <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
        <div class="prog-lbl"><span>FATE</span><span id="prog-pct">0%</span></div>
      </div>
    </div>
    <div class="hint-panel">
      <span class="hint-title">üí° SPIRIT HINT</span>
      <div id="hint-text">Roll the dice to move through the spirit realm. Land on glowing nodes to trigger events.</div>
      <button class="hint-next" onclick="nextHint()">‚ü° Next Hint ‚ü°</button>
    </div>
  </div>
</div>

<!-- LOG FEED -->
<div id="log-feed"></div>

<!-- ENCOUNTER MODAL -->
<div class="modal-bg" id="modal">
  <div class="modal-box">
    <div class="modal-badge" id="m-badge">‚Äî EVENT ‚Äî</div>
    <div class="modal-title" id="m-title">ENCOUNTER</div>
    <div class="modal-jp" id="m-jp">Âá∫‰ºö„ÅÑ</div>
    <span class="modal-art" id="m-art">?</span>
    <div class="modal-desc" id="m-desc"></div>
    <div class="modal-hint-box" id="m-hint"></div>
    <div class="modal-actions" id="m-acts"></div>
  </div>
</div>

<!-- WIN SCREEN -->
<div class="screen" id="win-screen">
  <div id="win-burst" style="position:fixed;inset:0;pointer-events:none;z-index:55;"></div>
  <span class="win-badge" id="win-badge">üå∏</span>
  <div class="win-title" id="win-title">THE GODDESS IS FREE</div>
  <div style="font-size:0.85rem;color:rgba(255,183,197,0.4);margin:4px 0 20px;letter-spacing:0.3em;">È≠Ç„ÅØËß£Êîæ„Åï„Çå„Åü</div>
  <div class="score-big" id="win-score">0</div>
  <div style="font-family:'Cinzel Decorative',serif;font-size:0.6rem;letter-spacing:0.3em;color:rgba(201,147,58,0.5);margin:4px 0 20px;">SOUL POINTS EARNED</div>
  <div id="win-stats" style="display:flex;gap:24px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;"></div>
  <div class="epilogue-wrap" id="win-epi"><h3>‚ú¶ EPILOGUE ‚Äî WHAT HAPPENED</h3></div>
  <button class="btn btn-gold btn-lg" onclick="restart()" style="margin-top:24px;">‚ú¶ Play Again ‚ú¶</button>
</div>

<!-- LOSE SCREEN -->
<div class="screen" id="lose-screen">
  <span style="font-size:5rem;display:block;">üåë</span>
  <div style="font-family:'Cinzel Decorative',serif;font-size:2.5rem;color:#ff4466;filter:drop-shadow(0 0 30px rgba(255,68,102,0.5));margin:16px 0;text-align:center;">THE PETALS HAVE FALLEN</div>
  <div style="font-size:0.9rem;color:rgba(255,107,138,0.4);letter-spacing:0.3em;margin-bottom:20px;">Ëä±„Å≥„Çâ„ÅØÊï£„Çä„Åæ„Åó„Åü</div>
  <div class="score-big" id="lose-score" style="color:#ff8899;">0</div>
  <div style="font-family:'Cinzel Decorative',serif;font-size:0.6rem;letter-spacing:0.3em;color:rgba(255,68,102,0.4);margin:4px 0 20px;">FINAL SOUL COUNT</div>
  <div class="epilogue-wrap" id="lose-epi" style="border-color:rgba(255,68,102,0.2);">
    <h3 style="color:#ff8899;">‚ú¶ WHAT WILL HAPPEN ‚Äî IF NO ONE COMES</h3>
  </div>
  <button class="btn btn-danger btn-lg" onclick="restart()" style="margin-top:24px;">‚ú¶ Try Again ‚ú¶</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THREE.JS 3D WORLD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('three-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x0d0508, 0.018);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 200);
camera.position.set(0, 14, 22);
camera.lookAt(0, 0, 0);

// LIGHTS
const ambLight = new THREE.AmbientLight(0x1a0508, 1.2);
scene.add(ambLight);
const moonLight = new THREE.DirectionalLight(0xffeedd, 0.8);
moonLight.position.set(10, 20, 10);
moonLight.castShadow = true;
scene.add(moonLight);
const sakuraLight = new THREE.PointLight(0xff88aa, 1.5, 40);
sakuraLight.position.set(0, 8, 0);
scene.add(sakuraLight);
const spiritLight = new THREE.PointLight(0x9b59b6, 1.2, 35);
spiritLight.position.set(-8, 5, -8);
scene.add(spiritLight);

// MAIN PLATFORM
const mainIslandGeo = new THREE.CylinderGeometry(16, 11, 1.2, 8);
const mainIslandMat = new THREE.MeshLambertMaterial({ color: 0x120810 });
const mainIsland = new THREE.Mesh(mainIslandGeo, mainIslandMat);
mainIsland.position.set(0, -1.5, 0);
mainIsland.receiveShadow = true;
scene.add(mainIsland);

// STARS
const starGeo = new THREE.BufferGeometry();
const starCount = 800;
const starPos = new Float32Array(starCount * 3);
for (let i = 0; i < starCount * 3; i++) starPos[i] = (Math.random() - 0.5) * 200;
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
const starMat = new THREE.PointsMaterial({ color: 0xffeedd, size: 0.18, transparent: true, opacity: 0.7 });
const stars = new THREE.Points(starGeo, starMat);
scene.add(stars);

// FLOATING PETALS
const petalGeo = new THREE.BufferGeometry();
const petalCount = 120;
const petalPositions = new Float32Array(petalCount * 3);
const petalVels = [];
for (let i = 0; i < petalCount; i++) {
  petalPositions[i*3]   = (Math.random()-0.5)*30;
  petalPositions[i*3+1] = Math.random()*20-5;
  petalPositions[i*3+2] = (Math.random()-0.5)*30;
  petalVels.push({ vx:(Math.random()-0.5)*0.015, vy:-0.01-Math.random()*0.015, vz:(Math.random()-0.5)*0.01 });
}
petalGeo.setAttribute('position', new THREE.BufferAttribute(petalPositions, 3));
const petalMat = new THREE.PointsMaterial({ color: 0xffb7c5, size: 0.22, transparent: true, opacity: 0.75 });
const petalSystem = new THREE.Points(petalGeo, petalMat);
scene.add(petalSystem);

// SOUL TREE
function buildSoulTree() {
  const group = new THREE.Group();
  const trunkGeo = new THREE.CylinderGeometry(0.3, 0.5, 5, 8);
  const trunkMat = new THREE.MeshLambertMaterial({ color: 0x4a1a2a });
  const trunk = new THREE.Mesh(trunkGeo, trunkMat);
  trunk.position.y = 2.5; trunk.castShadow = true;
  group.add(trunk);
  [[0,5.5,0,1.8],[1.2,4.5,0,1.2],[-1.2,4.5,0.5,1.2],[0,4.8,1.2,1.0],[-0.8,5.0,-1,1.3]].forEach(([x,y,z,r])=>{
    const bGeo = new THREE.SphereGeometry(r, 8, 6);
    const bMat = new THREE.MeshLambertMaterial({ color: 0xffb7c5, transparent: true, opacity: 0.55 });
    const b = new THREE.Mesh(bGeo, bMat);
    b.position.set(x, y, z);
    group.add(b);
  });
  const glowGeo = new THREE.SphereGeometry(0.4, 8, 8);
  const glowMat = new THREE.MeshBasicMaterial({ color: 0xffd700, transparent: true, opacity: 0.85 });
  const glow = new THREE.Mesh(glowGeo, glowMat);
  glow.position.set(0, 7.5, 0);
  group.add(glow);
  return group;
}
const soulTree = buildSoulTree();
scene.add(soulTree);

// NODES
const NODE_COLORS = {
  start:0xc9933a, exit:0xffd700, chest:0xf0c060, oni:0xff4466,
  shrine:0x1abc9c, portal:0x9b59b6, curse:0x8b0020, scroll:0x7fa8c8,
  relic:0xd4a0ff, normal:0x2d1320, heal:0x22ddaa
};
const nodeObjects = [];
const NODE_TYPES = ['normal','normal','chest','oni','shrine','portal','curse','scroll','relic','normal','heal'];
const NODES = [];

function buildNode3D(nx, nz, type, idx) {
  const g = new THREE.Group();
  const cylGeo = new THREE.CylinderGeometry(0.9, 0.75, 0.35, 7);
  const col = NODE_COLORS[type] || 0x2d1320;
  const cylMat = new THREE.MeshLambertMaterial({ color: col });
  const cyl = new THREE.Mesh(cylGeo, cylMat);
  cyl.castShadow = true; cyl.receiveShadow = true;
  g.add(cyl);
  const ringGeo = new THREE.TorusGeometry(1.0, 0.06, 8, 24);
  const ringMat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.6 });
  const ring = new THREE.Mesh(ringGeo, ringMat);
  ring.rotation.x = Math.PI / 2; ring.position.y = 0.2;
  g.add(ring);
  const orbGeo = new THREE.SphereGeometry(0.28, 8, 8);
  const orbMat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.85 });
  const orb = new THREE.Mesh(orbGeo, orbMat);
  orb.position.y = 0.85;
  g.add(orb);
  g.position.set(nx, 0, nz);
  g._idx = idx; g._type = type; g._orb = orb; g._ring = ringMat;
  scene.add(g);
  nodeObjects.push(g);
  return g;
}

function buildNodeGrid() {
  nodeObjects.forEach(n => scene.remove(n));
  nodeObjects.length = 0;
  NODES.length = 0;
  const cols = 5, rows = 5;
  const spacingX = 4.2, spacingZ = 3.8;
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const idx = r * cols + c;
      const x = (c - 2) * spacingX + (r % 2) * 2.1;
      const z = (r - 2) * spacingZ;
      const type = idx === 0 ? 'start' : idx === 24 ? 'exit'
        : NODE_TYPES[Math.floor(Math.random() * NODE_TYPES.length)];
      const n3 = buildNode3D(x, z, type, idx);
      NODES.push({ id: idx, x, z, type, visited: false, cleared: false, obj: n3 });
    }
  }
  NODES.forEach((n, i) => {
    if (i % 5 < 4) drawLine3D(n, NODES[i+1]);
    if (i < 20) drawLine3D(n, NODES[i+5]);
  });
}

function drawLine3D(a, b) {
  const pts = [new THREE.Vector3(a.x, 0.1, a.z), new THREE.Vector3(b.x, 0.1, b.z)];
  const geo = new THREE.BufferGeometry().setFromPoints(pts);
  const mat = new THREE.LineBasicMaterial({ color: 0x3a1a25, transparent: true, opacity: 0.4 });
  scene.add(new THREE.Line(geo, mat));
}

// PLAYER
let playerMesh = null;
function buildPlayer(classKey) {
  if (playerMesh) scene.remove(playerMesh);
  const g = new THREE.Group();
  const cols = { kenshi:0xff6688, miko:0xffd4e8, kitsune:0xff8844, ryuujin:0x44aaff };
  const col = cols[classKey] || 0xffb7c5;
  const bodyGeo = new THREE.CylinderGeometry(0.2, 0.28, 0.8, 8);
  const bodyMat = new THREE.MeshLambertMaterial({ color: col });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.85; body.castShadow = true;
  g.add(body);
  const headGeo = new THREE.SphereGeometry(0.22, 8, 8);
  const headMat = new THREE.MeshLambertMaterial({ color: 0xffddcc });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.55; head.castShadow = true;
  g.add(head);
  if (classKey === 'kenshi') {
    const sGeo = new THREE.CylinderGeometry(0.03, 0.03, 1.1, 5);
    const sMat = new THREE.MeshLambertMaterial({ color: 0xcccccc });
    const sword = new THREE.Mesh(sGeo, sMat);
    sword.position.set(0.4, 0.9, 0); sword.rotation.z = 0.3;
    g.add(sword);
  }
  const auraGeo = new THREE.SphereGeometry(0.55, 8, 8);
  const auraMat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.1, side: THREE.BackSide });
  g.add(new THREE.Mesh(auraGeo, auraMat));
  g.position.set(NODES[0].x, 0.18, NODES[0].z);
  g._baseY = 0.18;
  scene.add(g);
  playerMesh = g;
}

// CAMERA
let camTarget = new THREE.Vector3(0, 14, 22);
let camLook = new THREE.Vector3(0, 0, 0);
function moveCameraTo(node) {
  camTarget.set(node.x, 14, node.z + 20);
  camLook.set(node.x, 0, node.z);
}

// RAYCASTER
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const tooltip = document.getElementById('node-tooltip');
canvas.addEventListener('mousemove', e => {
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(scene.children, true);
  let found = null;
  for (const h of hits) {
    let obj = h.object;
    while (obj.parent && obj._idx === undefined) obj = obj.parent;
    if (obj._idx !== undefined) { found = obj; break; }
  }
  if (found && found._type) {
    tooltip.textContent = found._type.toUpperCase() + (found._idx === G.position ? ' ‚Äî YOU ARE HERE' : '');
    tooltip.style.display = 'block';
    tooltip.style.left = (e.clientX + 14) + 'px';
    tooltip.style.top  = (e.clientY - 10) + 'px';
  } else {
    tooltip.style.display = 'none';
  }
});

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// ANIMATION LOOP
const clock = new THREE.Clock();
function animate() {
  requestAnimationFrame(animate);
  const t = clock.getElapsedTime();
  camera.position.lerp(camTarget, 0.04);
  camera.lookAt(new THREE.Vector3(camLook.x, camLook.y, camLook.z));
  soulTree.children.forEach((c, i) => {
    if (c.geometry && c.geometry.type === 'SphereGeometry' && i > 0 && i < 6) {
      c.scale.setScalar(1 + Math.sin(t * 0.8 + i) * 0.05);
    }
  });
  soulTree.rotation.y = t * 0.1;
  sakuraLight.intensity = 1.2 + Math.sin(t * 1.2) * 0.4;
  spiritLight.intensity = 1.0 + Math.sin(t * 0.9 + 1) * 0.35;
  nodeObjects.forEach((n, i) => {
    if (n._orb) {
      n._orb.position.y = 0.85 + Math.sin(t * 1.5 + i * 0.4) * 0.12;
      n._orb.scale.setScalar(1 + Math.sin(t * 2 + i) * 0.06);
    }
  });
  if (playerMesh) {
    playerMesh.position.y = playerMesh._baseY + Math.sin(t * 2) * 0.08;
    playerMesh.rotation.y = t * 0.5;
    const nd = NODES[G.position];
    if (nd) {
      playerMesh.position.x += (nd.x - playerMesh.position.x) * 0.1;
      playerMesh.position.z += (nd.z - playerMesh.position.z) * 0.1;
    }
  }
  const pa = petalGeo.attributes.position.array;
  for (let i = 0; i < petalCount; i++) {
    pa[i*3]   += petalVels[i].vx;
    pa[i*3+1] += petalVels[i].vy;
    pa[i*3+2] += petalVels[i].vz;
    if (pa[i*3+1] < -6) { pa[i*3+1] = 15; pa[i*3] = (Math.random()-0.5)*30; pa[i*3+2] = (Math.random()-0.5)*30; }
  }
  petalGeo.attributes.position.needsUpdate = true;
  stars.rotation.y = t * 0.008;
  renderer.render(scene, camera);
}
animate();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLASSES = {
  kenshi:  { icon:'‚öîÔ∏è', jp:'Ââ£Â£´', hp:95,  rerolls:0, purify:0 },
  miko:    { icon:'‚õ©Ô∏è', jp:'Â∑´Â•≥', hp:100, rerolls:0, purify:3 },
  kitsune: { icon:'ü¶ä', jp:'Áãê',   hp:85,  rerolls:2, purify:0 },
  ryuujin: { icon:'üêâ', jp:'ÈæçÁ•û', hp:130, rerolls:0, purify:0 }
};
const MODES = {
  bond:   { label:'BOND OF SOULS', turns:20, total:3 },
  relic:  { label:'RELIC HUNT',    turns:28, total:5 },
  spirit: { label:'SPIRIT VIGIL',  turns:25, total:1 }
};
const RECOVERY = {
  prayer:  { name:'Shrine Prayer',  hp:25, cooldown:3, last:-99, emoji:'üôè' },
  herb:    { name:'Spirit Herb',    hp:20, cooldown:2, uses:3,   usesLeft:3, last:-99, emoji:'üåø' },
  dragon:  { name:'Dragon Breath',  hp:35, cooldown:5, last:-99, emoji:'üêâ' },
  meditate:{ name:'Meditate',       hp:15, cooldown:4, last:-99, emoji:'üßò' },
  offer:   { name:'Soul Offering',  hp:50, scoreCost:200, uses:2, usesLeft:2, last:-99, emoji:'üïØÔ∏è' }
};

let G = {};
let selClass = '', selMode = '';
let hintIdx = 0;

const HINTS = [
  'üå∏ LIFE RECOVERY: Use the left panel to restore HP between turns.',
  'üôè Shrine Prayer recovers 25 HP ‚Äî cooldown 3 turns.',
  'üåø Spirit Herb restores 20 HP ‚Äî you carry 3. Use wisely.',
  'üêâ Dragon Breath is Ryuujin only ‚Äî 35 HP, 5-turn cooldown.',
  'üßò Meditating grants +15 HP per turn for 3 turns.',
  'üïØÔ∏è Soul Offering sacrifices 200 pts for 50 HP.',
  '‚öîÔ∏è Kenshi: rolls 5-6 are critical strikes ‚Äî double damage!',
  '‚õ©Ô∏è Miko: purify a cursed tile 3 times per game.',
  'ü¶ä Kitsune: re-roll the dice twice per game.',
  '‚òØÔ∏è Light karma boosts shrine healing by +10 HP.',
  'üåÄ Portals can send you forward OR backward.',
  'üë∫ Defeating Oni with high karma grants bonus points.',
  'üí° Exit node only activates when ALL objectives are complete.',
  'üé≤ Rolling 6 on any combat triggers a perfect victory.'
];

function pickClass(c) {
  selClass = c;
  document.querySelectorAll('.cls-card').forEach(el => el.classList.remove('sel'));
  document.getElementById('cls-'+c).classList.add('sel');
  playTone(660, 'sine', 0.08, 0.07);
}
function pickMode(m) {
  selMode = m;
  document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('sel'));
  document.getElementById('mode-'+m).classList.add('sel');
  playTone(550, 'sine', 0.08, 0.07);
}
function nextHint() {
  hintIdx = (hintIdx + 1) % HINTS.length;
  document.getElementById('hint-text').textContent = HINTS[hintIdx];
  playTone(440, 'triangle', 0.08, 0.06);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  if (id) document.getElementById(id).classList.add('active');
}

function startGame() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) { document.getElementById('nameInput').style.borderColor='#ff4466'; return; }
  if (!selClass) { flashError('Choose your spirit class!'); return; }
  if (!selMode)  { flashError('Choose your sacred quest!'); return; }

  const cls = CLASSES[selClass];
  const mode = MODES[selMode];

  G = {
    name, cls: selClass, mode: selMode,
    hp: cls.hp, maxHp: cls.hp,
    score: 0, turn: 1, turnLimit: mode.turns,
    position: 0,
    kills: 0, shrines: 0, portals: 0, soulsSaved: 0,
    karma: 0,
    rerolls: cls.rerolls, purify: cls.purify, purifyNext: false,
    inventory: [],
    objectives: [],
    soulFragments: 0, relicsFound: 0,
    meditating: 0,
    gameOver: false, rolling: false, pending: false,
  };

  Object.keys(RECOVERY).forEach(k => {
    RECOVERY[k].last = -99;
    if (RECOVERY[k].usesLeft !== undefined) RECOVERY[k].usesLeft = RECOVERY[k].uses;
  });

  buildObjectives();
  buildNodeGrid();
  buildPlayer(selClass);
  NODES[0].visited = true;

  document.getElementById('hud-name').textContent = name;
  document.getElementById('hud-class').textContent = cls.jp + ' ‚Äî ' + selClass.toUpperCase();
  document.getElementById('hud-avatar').textContent = cls.icon;

  // HIDE all screens and show HUD
  showScreen(null);
  document.getElementById('hud').classList.add('active');
  document.getElementById('hud-bottom').classList.add('active');

  spawnAmbientPetals();
  buildActionBtns();
  updateHUD(); renderObjectives(); updateLifeButtons();
  moveCameraTo(NODES[0]);
  playStartup();
  log('[ The 3D Spirit Realm opens. Roll to begin your journey. ]', 'li-special');
}

function flashError(msg) {
  const div = document.createElement('div');
  div.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:200;background:rgba(255,68,102,0.15);border:1px solid #ff4466;border-radius:6px;padding:16px 32px;font-family:'Cinzel Decorative',serif;font-size:0.8rem;color:#ff8899;letter-spacing:0.15em;text-align:center;pointer-events:none;animation:fadeLabel 0.4s ease forwards;`;
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2000);
}

function buildObjectives() {
  if (G.mode === 'bond') {
    G.objectives = [
      {label:'Fragment of Memory', done:false},
      {label:'Fragment of Love',   done:false},
      {label:'Return to Soul Gate',done:false}
    ];
  } else if (G.mode === 'relic') {
    G.objectives = Array.from({length:5}, (_,i) => ({label:`Sacred Relic ${i+1}`, done:false}));
  } else {
    G.objectives = [{label:'Survive 25 turns', done:false}];
  }
}

function buildActionBtns() {
  const c = document.getElementById('action-btns');
  c.innerHTML = '';
  if (G.rerolls > 0) {
    const b = document.createElement('button');
    b.className = 'btn btn-spirit'; b.style.cssText='padding:8px 14px;font-size:0.58rem;';
    b.textContent = `‚ü° Re-Roll (${G.rerolls}x)`;
    b.onclick = () => { if (!G.rolling && !G.pending && G.rerolls > 0) { G.rerolls--; rollDice(); buildActionBtns(); } };
    c.appendChild(b);
  }
  if (G.cls === 'miko' && G.purify > 0) {
    const b2 = document.createElement('button');
    b2.className = 'btn btn-teal'; b2.style.cssText='padding:8px 14px;font-size:0.58rem;';
    b2.textContent = `‚õ© Purify (${G.purify}x)`;
    b2.onclick = () => { if (G.purify > 0) { G.purifyNext = true; G.purify--; log('‚õ©Ô∏è Purification ready. Next curse is cleansed.', 'li-good'); buildActionBtns(); } };
    c.appendChild(b2);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CINEMATIC DICE ROLL SEQUENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cinemaActive = false;

function rollDice() {
  if (G.rolling || G.gameOver || G.pending) return;
  G.rolling = true;
  const smallFace = document.getElementById('dice-face');
  smallFace.textContent = 'üé≤';
  playCinematicRoll();
}

function playCinematicRoll() {
  const overlay  = document.getElementById('cinema-overlay');
  const cinema   = document.getElementById('dice-cinema');
  const ring     = document.getElementById('spirit-ring');
  const ring2    = document.getElementById('spirit-ring2');
  const cDice    = document.getElementById('cinema-dice');
  const cNum     = document.getElementById('cinema-result-num');
  const cLabel   = document.getElementById('cinema-label');
  const cEvent   = document.getElementById('cinema-event-text');
  const rollLabel= document.getElementById('cinema-roll-label');

  // Reset state
  cNum.classList.remove('show');
  cLabel.classList.remove('show');
  cEvent.classList.remove('show');
  rollLabel.classList.remove('show');
  cDice.textContent = 'üé≤';
  cEvent.textContent = '';
  cNum.textContent = '';

  // Fade in dark overlay
  overlay.classList.add('dark');
  cinema.classList.add('active');
  ring.classList.add('active');
  ring2.classList.add('active');
  cinemaActive = true;

  // Show roll label
  setTimeout(() => { rollLabel.classList.add('show'); }, 200);

  // Slam dice in
  setTimeout(() => {
    cDice.classList.add('slam');
    setTimeout(() => cDice.classList.remove('slam'), 600);
    playRollSound();
  }, 350);

  // Tumbling number sequence
  const nums = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
  let tickCount = 0;
  const totalTicks = 22;
  const tickInterval = setInterval(() => {
    tickCount++;
    const speed = tickCount < 10 ? 1 : tickCount < 18 ? 2 : 3;
    if (tickCount % speed === 0) {
      const n = Math.ceil(Math.random() * 6);
      cDice.textContent = nums[n-1] || n;
      playTone(120 + n * 30, 'triangle', 0.04, 0.06);
      cDice.classList.add('tumble');
      setTimeout(() => cDice.classList.remove('tumble'), 80);
    }
    if (tickCount >= totalTicks) {
      clearInterval(tickInterval);
      // Final roll
      const finalRoll = Math.ceil(Math.random() * 6);
      cDice.textContent = nums[finalRoll-1];
      spawnCinematicPetals();
      revealResult(finalRoll, cDice, cNum, cLabel, cEvent, overlay, cinema, ring, ring2);
    }
  }, 55);
}

function revealResult(roll, cDice, cNum, cLabel, cEvent, overlay, cinema, ring, ring2) {
  // Slam / shockwave
  const wrap = document.getElementById('cinema-dice-wrap');
  const sw = document.createElement('div');
  sw.className = 'shockwave'; wrap.appendChild(sw);
  const sw2 = document.createElement('div');
  sw2.className = 'shockwave2'; wrap.appendChild(sw2);

  // Critical / special effects
  const isCrit = G.cls === 'kenshi' && roll >= 5;
  if (isCrit) {
    setTimeout(() => {
      const slash = document.createElement('div');
      slash.className = 'spirit-slash'; wrap.appendChild(slash);
      const slash2 = document.createElement('div');
      slash2.className = 'spirit-slash2'; wrap.appendChild(slash2);
      const cf = document.createElement('div');
      cf.className = 'crit-flash'; document.body.appendChild(cf);
      setTimeout(() => { slash.remove(); slash2.remove(); cf.remove(); }, 500);
    }, 100);
  }

  // Shockwave cleanup
  setTimeout(() => { sw.remove(); sw2.remove(); }, 1000);

  // Big result number
  setTimeout(() => {
    cNum.textContent = roll;
    cNum.classList.add('show');
    // Teal for high, red for low
    cNum.style.color = roll >= 5 ? '#f0c060' : roll >= 3 ? '#ffb7c5' : '#ff8899';
    cNum.style.textShadow = roll >= 5
      ? '0 0 30px rgba(240,192,96,0.9), 0 0 60px rgba(240,192,96,0.5)'
      : roll >= 3 ? '0 0 30px rgba(255,183,197,0.7)' : '0 0 30px rgba(255,68,102,0.7)';

    playResultTone(roll);
  }, 120);

  // Label
  setTimeout(() => cLabel.classList.add('show'), 300);

  // Event preview text
  setTimeout(() => {
    const eventLabel = getNodePreview(NODES[Math.min(G.position + roll, 24)].type);
    cEvent.textContent = isCrit ? '‚öîÔ∏è CRITICAL STRIKE ‚Äî ' + eventLabel : eventLabel;
    cEvent.style.color = isCrit ? '#ffb7c5' : 'rgba(255,183,197,0.75)';
    cEvent.classList.add('show');
  }, 500);

  // Hold for a beat, then close
  setTimeout(() => {
    closeCinema(overlay, cinema, ring, ring2);
    setTimeout(() => {
      G.rolling = false;
      document.getElementById('dice-face').textContent = roll;
      doMove(roll);
    }, 200);
  }, 1800);
}

function getNodePreview(type) {
  const labels = {
    oni:'üë∫ Oni Encountered', chest:'üì¶ Treasure Awaits', shrine:'‚õ©Ô∏è Sacred Shrine',
    portal:'üåÄ Spirit Portal', curse:'üíÄ Dark Curse', scroll:'üìú Ancient Scroll',
    relic:'‚ö±Ô∏è Sacred Relic', heal:'üíä Healing Spring', exit:'üå∏ Soul Gate',
    normal:'üåï Spirit Path', start:'‚õ© Origin'
  };
  return labels[type] || '‚ú¶ Fate Awaits';
}

function closeCinema(overlay, cinema, ring, ring2) {
  overlay.classList.remove('dark');
  cinema.classList.remove('active');
  ring.classList.remove('active');
  ring2.classList.remove('active');
  cinemaActive = false;
  // Clean up shockwaves / slashes
  document.querySelectorAll('.shockwave,.shockwave2,.spirit-slash,.spirit-slash2').forEach(e=>e.remove());
}

function spawnCinematicPetals() {
  const cinema = document.getElementById('dice-cinema');
  const petals = ['üå∏','üå∫','‚úø','‚ùÄ','üåº','üå∏'];
  for (let i = 0; i < 16; i++) {
    const p = document.createElement('div');
    p.className = 'cinema-petal';
    p.textContent = petals[Math.floor(Math.random() * petals.length)];
    const angle = (Math.random() * Math.PI * 2);
    const dist1 = 80 + Math.random() * 60;
    const dist2 = 180 + Math.random() * 120;
    const dist3 = 300 + Math.random() * 200;
    p.style.setProperty('--tx1', Math.cos(angle)*dist1 + 'px');
    p.style.setProperty('--ty1', Math.sin(angle)*dist1 + 'px');
    p.style.setProperty('--tx2', Math.cos(angle)*dist2 + 'px');
    p.style.setProperty('--ty2', Math.sin(angle)*dist2 + 'px');
    p.style.setProperty('--tx3', Math.cos(angle)*dist3 + 'px');
    p.style.setProperty('--ty3', Math.sin(angle)*dist3 + 'px');
    p.style.left = '50%'; p.style.top = '50%';
    p.style.fontSize = (0.8 + Math.random() * 0.9) + 'rem';
    p.style.animationDuration = (0.8 + Math.random() * 0.8) + 's';
    p.style.animationDelay = (Math.random() * 0.2) + 's';
    p.style.marginLeft = '-0.5rem'; p.style.marginTop = '-0.5rem';
    cinema.appendChild(p);
    setTimeout(() => p.remove(), 1800);
  }
}

// ‚îÄ‚îÄ‚îÄ LIFE RECOVERY ‚îÄ‚îÄ‚îÄ
function recoverLife(type) {
  if (G.gameOver || G.pending) return;
  const R = RECOVERY[type];
  const turnsElapsed = G.turn - R.last;
  if (type === 'dragon' && G.cls !== 'ryuujin') { log('üêâ Dragon Breath requires Ryuujin class!', 'li-bad'); return; }
  if (R.cooldown && turnsElapsed < R.cooldown) { log(`‚è≥ ${R.name} on cooldown ‚Äî ${R.cooldown - turnsElapsed} turns left.`, 'li-bad'); return; }
  if (R.usesLeft !== undefined && R.usesLeft <= 0) { log(`‚ö† ${R.name} ‚Äî no uses remaining.`, 'li-bad'); return; }
  if (type === 'offer' && G.score < R.scoreCost) { log(`‚ö† Soul Offering requires ${R.scoreCost} pts.`, 'li-bad'); return; }
  if (G.hp >= G.maxHp) { log('üíö Life force at maximum.', 'li-good'); return; }
  const oldHp = G.hp;
  if (type === 'meditate') {
    G.meditating = 3;
    log('üßò Meditation begins ‚Äî +15 HP each turn for 3 turns.', 'li-heal');
  } else {
    G.hp = Math.min(G.maxHp, G.hp + R.hp);
    log(`${R.emoji} ${R.name} ‚Äî restored +${G.hp - oldHp} HP! (${G.hp}/${G.maxHp})`, 'li-heal');
  }
  if (type === 'offer') G.score -= R.scoreCost;
  R.last = G.turn;
  if (R.usesLeft !== undefined) R.usesLeft--;
  healFlash(); playHeal(); updateHUD(); updateLifeButtons();
}

function updateLifeButtons() {
  const defs = [
    {id:'lb-prayer', key:'prayer'},{id:'lb-herb', key:'herb'},
    {id:'lb-dragon', key:'dragon'},{id:'lb-meditate', key:'meditate'},{id:'lb-offer', key:'offer'}
  ];
  defs.forEach(({id, key}) => {
    const btn = document.getElementById(id);
    if (!btn) return;
    const R = RECOVERY[key];
    let disabled = false;
    const turnsElapsed = G.turn - (R.last ?? -99);
    if (R.cooldown && turnsElapsed < R.cooldown) disabled = true;
    if (R.usesLeft !== undefined && R.usesLeft <= 0) disabled = true;
    if (key === 'dragon' && G.cls !== 'ryuujin') disabled = true;
    if (key === 'offer' && G.score < R.scoreCost) disabled = true;
    if (G.hp >= G.maxHp) disabled = true;
    btn.disabled = disabled;
    let costLabel = '';
    if (key === 'herb')    costLabel = `+20 HP (${R.usesLeft}/${R.uses} left)`;
    else if (key === 'offer') costLabel = `+50 HP (-${R.scoreCost}pts)`;
    else if (R.cooldown && turnsElapsed < R.cooldown) costLabel = `CD: ${R.cooldown - turnsElapsed}t`;
    const lbcost = btn.querySelector('.lbcost');
    if (lbcost && costLabel) lbcost.textContent = costLabel;
  });
}

function healFlash() {
  const f = document.getElementById('heal-flash');
  f.classList.remove('show'); void f.offsetWidth; f.classList.add('show');
  const track = document.getElementById('hp-track');
  track.classList.add('healing');
  setTimeout(() => track.classList.remove('healing'), 700);
}

// ‚îÄ‚îÄ‚îÄ MOVE ‚îÄ‚îÄ‚îÄ
function doMove(roll) {
  if (G.cls === 'ryuujin' && roll < 3) {
    G.hp = Math.min(G.maxHp, G.hp + 5);
    log('üêâ Dragon vitality: +5 HP from slow movement.', 'li-heal');
    healFlash();
  }
  if (G.meditating > 0) {
    G.hp = Math.min(G.maxHp, G.hp + 15);
    G.meditating--;
    log(`üßò Meditate regen: +15 HP. (${G.meditating} turns left)`, 'li-heal');
    healFlash();
  }
  const newPos = Math.min(G.position + roll, 24);
  G.position = newPos;
  NODES[newPos].visited = true;
  G.turn++; G.score += 8;
  moveCameraTo(NODES[newPos]);
  updateHUD(); updateLifeButtons();
  if (G.turn > G.turnLimit && G.mode !== 'spirit') {
    setTimeout(() => openModal('THE LAST PETAL FALLS','‚Äî FATE ‚Äî','üåë',
      'Time has run out. The Soul Tree\'s final petal drops into the void.',
      'When time expires, the bravest Keeper cannot hold back fate.',
      [{label:'Accept the End', cls:'btn-danger', act:'gameover'}]
    ), 600);
    return;
  }
  if (G.mode === 'spirit' && G.turn % 5 === 0) {
    G.soulsSaved++; G.score += 60;
    log(`üïØÔ∏è Your vigil saves another soul. ${G.soulsSaved} souls returned!`, 'li-special');
    if (G.turn >= G.turnLimit) { G.objectives[0].done = true; renderObjectives(); setTimeout(triggerWin, 600); return; }
  }
  setTimeout(() => triggerNode(newPos), 700);
}

// ‚îÄ‚îÄ‚îÄ NODE EVENTS ‚îÄ‚îÄ‚îÄ
function triggerNode(pos) {
  const node = NODES[pos];
  const t = node.type;
  G.pending = true;
  if (t === 'start') { G.pending = false; return; }
  if (t === 'exit') {
    if (checkWin()) { triggerWin(); return; }
    log('üå∏ Soul Gate found ‚Äî mission incomplete.', 'li-spirit');
    G.pending = false; return;
  }
  if (G.purifyNext && (t === 'curse' || t === 'oni')) {
    G.purifyNext = false; node.cleared = true;
    G.score += 50; G.karma += 15;
    log('‚õ©Ô∏è Miko purification! Corruption cleansed.', 'li-good');
    G.pending = false; updateHUD(); return;
  }
  const dispatch = { oni:showOni, chest:showChest, shrine:showShrine, portal:showPortal,
    curse:showCurse, scroll:showScroll, relic:showRelic, heal:showHealNode };
  (dispatch[t] || showNormal)();
}

const ONI_DATA = [
  {n:'Kage-Oni',jp:'ÂΩ±È¨º',art:'üë∫',d:'A shadow demon that feeds on memories. You feel your mother\'s face blurring at the edges of your mind.',h:'Roll 3+ to win. Kenshi gets +1. Slay it to save a soul.'},
  {n:'Mugen\'s Shade',jp:'ÁÑ°Èôê„ÅÆÂΩ±',art:'ü©∏',d:'A fragment of the Endless Demon. It whispers: "She is already gone." Do not believe it.',h:'Never trust Mugen\'s Shade. Fight or flee ‚Äî both have consequences.'},
  {n:'Bone Lantern',jp:'È™®ÊèêÁÅØ',art:'üèÆ',d:'A corrupted spirit lantern. Inside its flame is a trapped human soul ‚Äî screaming silently. Defeat it to free the soul.',h:'Defeating this Oni saves a soul and adds +80 pts bonus.'},
];
const CHEST_DATA = [
  {n:'Memory Chest',jp:'Ë®òÊÜ∂„ÅÆÁÆ±',art:'üì¶',d:'A chest warm to the touch ‚Äî as if it remembers the hands that last held it.',h:'Force open for speed. Examine carefully to avoid traps.'},
  {n:'The Goddess\'s Gift',jp:'Â•≥Á•û„ÅÆË¥à„ÇäÁâ©',art:'üéÅ',d:'A box that smells of cherry blossoms and rain. You feel longing in your chest ‚Äî not pain, but love.',h:'These chests are always safe. They are her way of saying thank you.'},
];
const SCROLL_DATA = [
  {n:'Ancient Scroll',jp:'Âè§‰ª£„ÅÆÂ∑ªÁâ©',art:'üìú',d:'"When the Keeper rolls true and the cherry blooms again, I will open my eyes." ‚Äî Y≈´rei-no-Hana',h:'Scrolls restore 10 HP and grant 40 soul points.'},
  {n:'The Goddess\'s Letter',jp:'Â•≥Á•û„ÅÆÊâãÁ¥ô',art:'üìñ',d:'"Mugen was my student once. When love becomes possession, it becomes a cage. Free me... and forgive him."',h:'Collect all scrolls for the true ending.'},
];
const SHRINE_DATA = [
  {n:'Forgotten Shrine',jp:'Âøò„Çå„Çâ„Çå„ÅüÁ•ûÁ§æ',art:'‚õ©Ô∏è',d:'Moss-covered stone. An old offering bowl with long-dried flowers. You add your prayer. Something warm answers.',h:'Shrines heal 20-30 HP and reset Shrine Prayer cooldown.'},
  {n:'Weeping Shrine',jp:'Ê≥£„ÅèÁ•ûÁ§æ',art:'üïØÔ∏è',d:'A child\'s toy rests against the stone ‚Äî a child who never came home from the Night of Fallen Petals.',h:'Praying adds Light karma and +1 to your next combat roll.'},
];
const RELIC_DATA = [
  {n:'The Bell of Parting',jp:'Âà•„Çå„ÅÆÈêò',art:'üîî',d:'A small bronze bell. Its sound is so achingly beautiful that you stop breathing for a moment.',h:'Sacred relic. Collect for your mission.'},
  {n:'The Mirror of Souls',jp:'È≠Ç„ÅÆÈè°',art:'ü™û',d:'You look expecting your reflection. Instead you see the Goddess ‚Äî chained in shadow. She mouths: "Hurry. Please."',h:'Grants major score bonus and reveals a story fragment.'},
];

function showOni() {
  const e = ONI_DATA[~~(Math.random()*ONI_DATA.length)];
  const acts = [
    {label:'‚öîÔ∏è Fight with Honor', cls:'btn-danger', act:'fight'},
    {label:'üèÉ Flee into Shadow', cls:'btn',         act:'flee'}
  ];
  if (G.cls==='miko') acts.push({label:'‚õ©Ô∏è Sacred Prayer', cls:'btn-teal', act:'prayer-fight'});
  if (G.cls==='kitsune') acts.push({label:'ü¶ä Illusion Trick', cls:'btn-spirit', act:'trick'});
  playSound('oni');
  openModal(e.n, e.jp, e.art, e.d, e.h, acts);
}
function showChest() {
  const e = CHEST_DATA[~~(Math.random()*CHEST_DATA.length)];
  playSound('chest');
  openModal(e.n, e.jp, e.art, e.d, e.h, [
    {label:'üì¶ Open with Hope', cls:'btn-gold', act:'chest-force'},
    {label:'üîç Examine Carefully', cls:'btn', act:'chest-safe'},
  ]);
}
function showShrine() {
  const e = SHRINE_DATA[~~(Math.random()*SHRINE_DATA.length)];
  playSound('shrine');
  openModal(e.n, e.jp, e.art, e.d, e.h, [
    {label:'üôè Pray and Offer', cls:'btn-teal', act:'shrine'},
    {label:'‚Üí Pass By', cls:'btn', act:'close', pts:0},
  ]);
}
function showPortal() {
  playSound('portal');
  openModal('Spirit Portal','Á≤æÁ•û„Éù„Éº„Çø„É´','üåÄ',
    'A swirling gate of violet light tears open reality. The wind carries the scent of ancient forests, temple bells, and starlight.',
    'Portals can jump you 2-6 nodes forward OR backward.',
    [{label:'üåÄ Step Through',cls:'btn-spirit',act:'portal'},{label:'‚Üê Turn Back',cls:'btn',act:'close',pts:5}]
  );
}
function showCurse() {
  playSound('curse');
  openModal('Cursed Hex','Âë™„Çè„Çå„ÅüÂë™Êñá','üíÄ',
    'A dark symbol burns into the ground beneath your feet. The air turns cold. Mugen-Oni laid this tile himself.',
    'Cursed tiles: 15-25 damage. Ryuujin takes only 10. Miko can purify these entirely.',
    [{label:'‚ö° Push Through', cls:'btn-danger', act:'curse'},
     {label:'‚öîÔ∏è Resist Actively', cls:'btn', act:'curse-resist'}]
  );
}
function showScroll() {
  const e = SCROLL_DATA[~~(Math.random()*SCROLL_DATA.length)];
  playSound('scroll');
  openModal(e.n, e.jp, e.art, e.d, e.h, [{label:'üìú Read with Care', cls:'btn-gold', act:'scroll'}]);
}
function showRelic() {
  const e = RELIC_DATA[~~(Math.random()*RELIC_DATA.length)];
  playSound('chest');
  openModal(e.n, e.jp, e.art, e.d, e.h, [{label:'‚ö±Ô∏è Collect the Relic', cls:'btn-gold', act:'relic'}]);
}
function showHealNode() {
  playSound('heal');
  openModal('Sacred Healing Spring','Áôí„Åó„ÅÆÊ≥â','üíä',
    'A crystal-clear spring bubbles up from the spirit realm floor, glowing softly in teal light. It is calling to you.',
    'Healing Springs restore 30 HP regardless of class.',
    [{label:'üíä Drink from the Spring', cls:'btn-teal', act:'heal-node'}]
  );
}
function showNormal() {
  const normals = [
    {n:'Drifting Soul',jp:'ÊºÇ„ÅÜÈ≠Ç',art:'üëª',d:'A transparent figure drifts past ‚Äî untethered since the Night of Fallen Petals. Its eyes hold a question it has forgotten how to ask.',h:'Lost souls sometimes leave items. Search the area.'},
    {n:'Cherry Blossom Storm',jp:'Ê°úÂêπÈõ™',art:'üå∏',d:'Sakura petals fill the air. For a moment you feel the Soul Tree breathing. As if it knows you are coming.',h:'Safe rest tile. You are doing better than you think.'},
    {n:'Moonlit Path',jp:'ÊúàÊòé„Åã„Çä„ÅÆÈÅì',art:'üåï',d:'The path glows silver under an impossibly large moon. A temple bell rings ‚Äî three times, then silence.',h:'No danger here. Every step forward matters.'},
  ];
  const e = normals[~~(Math.random()*normals.length)];
  openModal(e.n, e.jp, e.art, e.d, e.h, [{label:'Continue Forward', cls:'btn', act:'close', pts:15}]);
}

function openModal(title, jp, art, desc, hint, actions) {
  document.getElementById('m-badge').textContent = '‚Äî ' + (jp || 'EVENT') + ' ‚Äî';
  document.getElementById('m-title').textContent = title;
  document.getElementById('m-jp').textContent = jp;
  document.getElementById('m-art').textContent = art;
  document.getElementById('m-desc').innerHTML = desc;
  document.getElementById('m-hint').textContent = hint;
  const ac = document.getElementById('m-acts');
  ac.innerHTML = '';
  actions.forEach(a => {
    const b = document.createElement('button');
    b.className = 'btn ' + (a.cls||'');
    b.textContent = a.label;
    b.onclick = () => resolve(a);
    ac.appendChild(b);
  });
  document.getElementById('modal').classList.add('open');
}
function closeModal() { document.getElementById('modal').classList.remove('open'); G.pending = false; }

function resolve(a) {
  closeModal();
  NODES[G.position].cleared = true;
  switch(a.act) {
    case 'close':
      if (a.pts) { G.score += a.pts; log(`You press onward. +${a.pts} soul points.`, 'li-spirit'); }
      else log('You move on through the spirit realm.', 'li-spirit');
      break;
    case 'fight': {
      const roll = Math.ceil(Math.random()*6);
      const bonus = G.cls==='kenshi' ? 1 : 0;
      const crit = G.cls==='kenshi' && (roll+bonus)>=5;
      if (roll+bonus >= 3) {
        const pts = crit ? 200 : 80+roll*15;
        G.kills++; G.score+=pts; G.karma+=10; G.soulsSaved++;
        log(`‚öîÔ∏è Victory! Roll:${roll}${bonus?'+1':''}.${crit?' CRITICAL!':''} +${pts}pts.`, 'li-good');
        checkBondProgress(); playSound('win');
      } else {
        const dmg = ~~(Math.random()*20)+15;
        G.hp-=dmg; G.karma-=5;
        log(`üíî Defeated. -${dmg} HP remaining: ${G.hp}.`, 'li-bad');
        playSound('hurt'); checkDead();
      }
      break;
    }
    case 'prayer-fight': {
      const roll = Math.ceil(Math.random()*6)+1;
      if (roll>=3) { G.kills++; G.score+=100; G.karma+=20; G.soulsSaved++; log('‚õ©Ô∏è Sacred prayer banishes the Oni! +100 pts.', 'li-good'); checkBondProgress(); }
      else { G.hp-=10; log('üôè Prayer weakened it but failed. -10 HP.', 'li-bad'); checkDead(); }
      break;
    }
    case 'trick': {
      const roll = Math.ceil(Math.random()*6);
      if (roll>=3) { G.score+=90; G.karma+=5; log('ü¶ä Illusion trick works! +90 pts.', 'li-good'); }
      else { G.hp-=8; log('ü¶ä The trick failed. -8 HP.', 'li-bad'); checkDead(); }
      break;
    }
    case 'flee': {
      const dmg = ~~(Math.random()*12)+5;
      G.hp-=dmg; G.karma-=8; G.score+=10;
      log(`üèÉ Fled! -${dmg} HP. Karma suffers.`, 'li-bad');
      checkDead(); break;
    }
    case 'chest-force': {
      if (Math.random()>0.22) { giveItem(); G.score+=80; log('üì¶ Chest opened ‚Äî loot acquired! +80 pts.', 'li-special'); playSound('loot'); }
      else { const d=18; G.hp-=d; log(`üí• Trap! -${d} HP.`, 'li-bad'); checkDead(); }
      break;
    }
    case 'chest-safe': {
      giveItem(); G.score+=60; log('üì¶ Examined safely. +60 pts.', 'li-special'); playSound('loot'); break;
    }
    case 'shrine': {
      const base = G.karma >= 0 ? 25 : 15;
      const bonus = G.cls === 'miko' ? 10 : 0;
      const heal = base + bonus;
      G.hp = Math.min(G.maxHp, G.hp + heal);
      G.karma+=12; G.shrines++; G.score+=50;
      RECOVERY.prayer.last = G.turn - RECOVERY.prayer.cooldown - 1;
      log(`‚õ©Ô∏è Prayers answered. +${heal} HP. Shrine Prayer reset!`, 'li-heal');
      healFlash(); playSound('shrine'); break;
    }
    case 'portal': {
      const dir = Math.random()>0.3 ? 1 : -1;
      const jump = dir*(~~(Math.random()*4)+2);
      const np = Math.max(0, Math.min(24, G.position+jump));
      G.position=np; NODES[np].visited=true;
      G.portals++; G.score+=35;
      moveCameraTo(NODES[np]);
      log(`üåÄ Portal! ${Math.abs(jump)} nodes ${jump>0?'forward':'backward'}. +35 pts.`, jump>0?'li-good':'li-spirit');
      break;
    }
    case 'curse': {
      const dmg = G.cls==='ryuujin' ? 10 : ~~(Math.random()*10)+15;
      G.hp-=dmg; G.karma-=5;
      log(`üíÄ Curse strikes! -${dmg} HP.`, 'li-bad');
      checkDead(); break;
    }
    case 'curse-resist': {
      const roll = Math.ceil(Math.random()*6);
      const dmg = roll>=4 ? 5 : (G.cls==='ryuujin'?10:18);
      G.hp-=dmg; G.score+=20;
      log(`üí™ Resist! Roll:${roll}. -${dmg} HP. +20 pts.`, roll>=4?'li-good':'li-bad');
      checkDead(); break;
    }
    case 'scroll': {
      G.hp = Math.min(G.maxHp, G.hp+10);
      G.score+=40; G.karma+=8;
      log('üìú Her words heal your spirit. +10 HP, +40 pts.', 'li-spirit');
      healFlash(); break;
    }
    case 'relic': {
      G.relicsFound++;
      const relics=[
        {icon:'üîî',name:'Bell of Parting'},{icon:'ü™û',name:'Mirror of Souls'},
        {icon:'ü™≠',name:'Fan of Winds'},{icon:'‚ö±Ô∏è',name:'Soul Urn'},
        {icon:'ü™¨',name:'Spirit Talisman'}
      ];
      const it = relics[(G.relicsFound-1) % relics.length];
      if (G.inventory.length<8) G.inventory.push(it);
      G.score+=150;
      if (G.mode==='relic' && G.relicsFound<=5) {
        G.objectives[G.relicsFound-1].done=true;
        log(`‚ö±Ô∏è Relic ${G.relicsFound}/5: ${it.name}! +150 pts.`, 'li-special');
        renderObjectives();
        if (G.relicsFound>=5) { setTimeout(triggerWin,600); return; }
      } else {
        log(`‚ö±Ô∏è Relic: ${it.name}! +150 pts.`, 'li-special');
      }
      break;
    }
    case 'heal-node': {
      G.hp = Math.min(G.maxHp, G.hp+30);
      G.score+=30;
      log('üíä Sacred Spring! +30 HP! +30 pts.', 'li-heal');
      healFlash(); playSound('heal'); break;
    }
    case 'gameover': triggerLose(); return;
  }
  updateHUD(); updateLifeButtons(); renderObjectives(); buildActionBtns();
  if (G.mode==='spirit' && G.turn>=G.turnLimit) {
    G.objectives[0].done=true; renderObjectives(); setTimeout(triggerWin,600);
  }
}

function checkBondProgress() {
  if (G.mode!=='bond') return;
  if (G.kills>=1 && !G.objectives[0].done) { G.objectives[0].done=true; G.soulFragments++; log('üå∏ Fragment of Memory recovered!','li-special'); }
  if (G.kills>=3 && !G.objectives[1].done) { G.objectives[1].done=true; G.soulFragments++; log('üå∏ Fragment of Love recovered!','li-special'); }
  renderObjectives();
}
function checkWin() {
  if (G.mode==='bond')   return G.soulFragments>=2;
  if (G.mode==='relic')  return G.relicsFound>=5;
  if (G.mode==='spirit') return G.turn>=G.turnLimit;
  return false;
}
function giveItem() {
  const pool=[
    {icon:'üíä',name:'Spirit Herb'},{icon:'‚ö°',name:'Ki Stone'},
    {icon:'üõ°Ô∏è',name:'Jade Armor'},{icon:'üå∏',name:'Soul Petal'},
    {icon:'üîÆ',name:'Void Bead'},{icon:'üéã',name:'Bamboo Ward'},
    {icon:'üßß',name:'Lucky Charm'},{icon:'üïØÔ∏è',name:'Vigil Candle'},
  ];
  const it = pool[~~(Math.random()*pool.length)];
  if (['Spirit Herb','Ki Stone'].includes(it.name)) {
    const h=it.name==='Spirit Herb'?18:10;
    G.hp=Math.min(G.maxHp,G.hp+h);
    log(`üíä ${it.name} found ‚Äî +${h} HP!`,'li-heal');
    healFlash();
  }
  if (G.inventory.length<8) G.inventory.push(it);
}
function checkDead() {
  updateHUD();
  if (G.hp<=0) { G.hp=0; G.gameOver=true; updateHUD(); setTimeout(triggerLose,900); }
}

// WIN / LOSE
const WIN_EPI = `<p>As your final action sends the last fragment of her spirit free, the sky cracks open like an old wound finally allowed to heal.</p>
<p>The Soul Tree ‚Äî grey and leafless for three long years ‚Äî exhales. A single petal unfurls. Then another. Then a million ‚Äî all at once, like a held breath finally released.</p>
<p>You hear her voice for the first time. It sounds like something you have always known but never found the word for. She says your name ‚Äî your real name, the one written in the bark of the Soul Tree long before you were born.</p>
<p><em>"You came,"</em> she says. <em>"I was not sure anyone would."</em></p>
<p>Every soul that Mugen had swallowed returns ‚Äî not as ghosts, but as light. Children wake from their long sleep. The lanterns relight themselves.</p>
<p style="color:#ffb7c5;font-style:italic;text-align:center;">You feel, for the first time, at home.</p>`;

const LOSE_EPI = `<p>Without the Tamashii-Keeper, the Soul Tree's last leaf falls at dawn on the third day.</p>
<p>People do not die dramatically. They simply thin. Their laughter becomes quieter. Their memories shorter.</p>
<p style="color:#ffb7c5;font-style:italic;text-align:center;font-size:1rem;">"Please. Someone. Come."</p>
<p style="opacity:0.4;font-style:italic;text-align:center;">The dice remain on the table. They can be rolled again.</p>`;

function triggerWin() {
  G.gameOver=true;
  G.score += G.hp*2 + G.kills*50 + G.shrines*30;
  const badges={bond:'üå∏',relic:'‚ö±Ô∏è',spirit:'üïØÔ∏è'};
  const titles={bond:'The Goddess Breathes Again',relic:'The Relics Reunited',spirit:'The Vigil Held True'};
  document.getElementById('win-badge').textContent=badges[G.mode];
  document.getElementById('win-title').textContent=titles[G.mode];
  document.getElementById('win-score').textContent=G.score.toLocaleString();
  document.getElementById('win-epi').innerHTML='<h3>‚ú¶ EPILOGUE ‚Äî WHAT HAPPENED</h3>'+WIN_EPI;
  document.getElementById('win-stats').innerHTML=[
    mkS(G.kills,'Oni Vanquished','#ff8899'),
    mkS(G.shrines,'Shrines Blessed','#aff0e0'),
    mkS(G.soulsSaved,'Souls Saved','#f0c060'),
    mkS(G.turn,'Turns Taken','#ffb7c5'),
  ].join('');
  hideHUD(); showScreen('win-screen'); spawnWinBurst(); playVictory();
}
function triggerLose() {
  G.gameOver=true;
  document.getElementById('lose-score').textContent=G.score.toLocaleString();
  document.getElementById('lose-epi').innerHTML='<h3 style="color:#ff8899;">‚ú¶ WHAT WILL HAPPEN ‚Äî IF NO ONE COMES</h3>'+LOSE_EPI;
  hideHUD(); showScreen('lose-screen'); playSound('gameover');
}
function mkS(v,l,c){return `<div style="text-align:center"><div style="font-family:'Cinzel Decorative',serif;font-size:1.5rem;color:${c}">${v}</div><div style="font-family:'Cinzel Decorative',serif;font-size:0.5rem;color:rgba(201,147,58,0.4);letter-spacing:0.2em">${l}</div></div>`;}
function hideHUD() {
  document.getElementById('hud').classList.remove('active');
  document.getElementById('hud-bottom').classList.remove('active');
}
function restart() { location.reload(); }

// ‚îÄ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ
function updateHUD() {
  document.getElementById('hud-score').textContent = G.score;
  document.getElementById('hud-turn').textContent  = `${G.turn}/${G.turnLimit}`;
  document.getElementById('hud-kills').textContent = G.kills;
  const pct = Math.max(0,(G.hp/G.maxHp)*100);
  document.getElementById('hp-fill').style.width = pct+'%';
  document.getElementById('hp-num').textContent = Math.max(0,G.hp);
  const k = G.karma;
  document.getElementById('karma-l').style.width = Math.max(0,k/100*50)+'%';
  document.getElementById('karma-d').style.width = Math.max(0,-k/100*50)+'%';
  document.getElementById('karma-label').textContent =
    k>40?'Pure Light':k>10?'Light':k<-40?'Dark Soul':k<-10?'Shadow':'Neutral';
}
function renderObjectives() {
  const el = document.getElementById('obj-list');
  el.innerHTML='';
  G.objectives.forEach(o=>{
    const d=document.createElement('div');
    d.className='obj-item'+(o.done?' done':'');
    d.innerHTML=`<span class="obj-dot">${o.done?'‚ú¶':'‚óã'}</span>${o.label}`;
    el.appendChild(d);
  });
  let prog=0;
  if (G.mode==='bond')   prog=(G.soulFragments/2)*100;
  else if (G.mode==='relic') prog=(G.relicsFound/5)*100;
  else prog=((G.turn-1)/G.turnLimit)*100;
  prog=Math.min(100,prog);
  document.getElementById('prog-fill').style.width=prog+'%';
  document.getElementById('prog-pct').textContent=Math.round(prog)+'%';
}

// LOG
const logFeed = document.getElementById('log-feed');
function log(msg, cls='') {
  const d=document.createElement('div');
  d.className='log-item '+(cls||'');
  d.innerHTML=msg;
  logFeed.insertBefore(d, logFeed.firstChild);
  setTimeout(()=>d.remove(), 4200);
  while(logFeed.children.length>6) logFeed.removeChild(logFeed.lastChild);
}

// PETALS
function spawnAmbientPetals() {
  const layer = document.getElementById('petal-layer');
  layer.innerHTML='';
  'üå∏üå∫üçÉ‚úø‚ùÄüå∏üå∏'.split('').forEach((p)=>{
    const el=document.createElement('div');
    el.className='petal'; el.textContent=p;
    el.style.cssText=`left:${Math.random()*100}%;animation-duration:${9+Math.random()*13}s;animation-delay:${Math.random()*10}s;font-size:${0.6+Math.random()*0.8}rem;`;
    layer.appendChild(el);
  });
}
function spawnWinBurst() {
  const b=document.getElementById('win-burst'); b.innerHTML='';
  for(let i=0;i<80;i++){
    const p=document.createElement('div'); p.className='burst-petal';
    p.textContent=['üå∏','üå∫','‚úø','‚ùÄ','üåº'][~~(Math.random()*5)];
    p.style.cssText=`left:${Math.random()*100}%;top:${-5+Math.random()*15}%;font-size:${0.8+Math.random()*1.2}rem;animation-duration:${2+Math.random()*4}s;animation-delay:${Math.random()*2}s;`;
    b.appendChild(p);
  }
}

// ‚îÄ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ‚îÄ
let actx;
function getCtx(){ if(!actx) actx=new(window.AudioContext||window.webkitAudioContext)(); return actx; }
function playTone(f,t,d,v=0.12,dl=0){
  try{
    const c=getCtx(),o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);
    o.type=t;o.frequency.value=f;
    g.gain.setValueAtTime(0,c.currentTime+dl);
    g.gain.linearRampToValueAtTime(v,c.currentTime+dl+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+dl+d);
    o.start(c.currentTime+dl);o.stop(c.currentTime+dl+d+0.05);
  }catch(e){}
}
function playRollSound(){
  // Ascending cascade of tones for dramatic roll
  for(let i=0;i<10;i++) playTone(150+i*25,'triangle',0.07,0.08,i*0.06);
}
function playResultTone(roll) {
  const freqs = { 1:[196,220], 2:[220,262], 3:[262,330], 4:[330,392], 5:[440,523,659], 6:[523,659,784,1047] };
  (freqs[roll]||[440]).forEach((f,i) => playTone(f,'sine',0.3,0.12,i*0.1));
}
function playHeal(){[523,659,784,1046].forEach((f,i)=>playTone(f,'sine',0.25,0.09,i*0.08));}
function playSound(s){
  switch(s){
    case 'oni':     playTone(60,'sawtooth',0.5,0.22);playTone(80,'square',0.3,0.18,0.1);break;
    case 'chest':   playTone(392,'sine',0.2,0.1);playTone(523,'sine',0.2,0.1,0.12);playTone(659,'sine',0.3,0.1,0.24);break;
    case 'shrine':  [392,494,587,784].forEach((f,i)=>playTone(f,'sine',0.3,0.09,i*0.1));break;
    case 'scroll':  playTone(523,'sine',0.25,0.1);playTone(659,'sine',0.2,0.08,0.15);break;
    case 'portal':  playTone(330,'sine',0.3,0.15);playTone(440,'sine',0.2,0.1,0.15);break;
    case 'curse':   playTone(55,'sawtooth',0.4,0.25);playTone(65,'square',0.2,0.2,0.1);break;
    case 'win':     playTone(523,'sine',0.2,0.15);playTone(659,'sine',0.15,0.12,0.1);playTone(784,'sine',0.12,0.1,0.2);break;
    case 'hurt':    playTone(100,'sawtooth',0.35,0.2);playTone(80,'sawtooth',0.25,0.15,0.08);break;
    case 'loot':    playTone(784,'sine',0.15,0.1);playTone(988,'sine',0.1,0.08,0.1);break;
    case 'heal':    playHeal();break;
    case 'gameover':playTone(196,'sawtooth',0.6,0.15);playTone(146,'square',0.4,0.12,0.2);break;
  }
}
function playStartup(){[262,330,392,523,659,784].forEach((f,i)=>playTone(f,'sine',0.3,0.1,i*0.09));}
function playVictory(){[392,494,587,740,880,1047].forEach((f,i)=>playTone(f,'sine',0.4,0.12,i*0.1));}

// Init G with a dummy position so tooltips don't error before game starts
G = { position: -1 };
</script>
</body>
</html>
